<div id="sip-swp-app" style="width:100%;height:100%;box-sizing:border-box;"><style> :root {
    --bg: #050816;
    --bg-alt: #0b1020;
    --card: #111827;
    --accent: #6366f1;
    --accent-soft: rgba(99, 102, 241, 0.12);
    --accent-strong: rgba(99, 102, 241, 0.25);
    --text: #e5e7eb;
    --muted: #9ca3af;
    --danger: #f97373;
    --success: #22c55e;
    --warning: #facc15;
    --border: #1f2937;
    --radius-lg: 14px;
    --radius-md: 10px;
    --radius-sm: 6px;
    --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.8);
    --shadow-subtle: 0 10px 25px rgba(15, 23, 42, 0.6);
    --input-bg: #020617;
    --input-border: #1f2937;
    --input-border-focus: #4f46e5;
}

#sip-swp-app * {
    box-sizing: border-box;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
}

#sip-swp-app {
    padding: 18px;
    background: radial-gradient(circle at top, #111827 0, #020617 50%, #020617 100%);
    color: var(--text);
}

.app-shell {
    max-width: 1160px;
    margin: 0 auto;
    border-radius: 22px;
    border: 1px solid rgba(148, 163, 184, 0.15);
    background: radial-gradient(circle at top left, #111827, #020617);
    box-shadow: var(--shadow-soft);
    padding: 18px;
}

@media (min-width: 900px) {
    .app-shell {
        padding: 22px 24px 26px;
    }
}

.app-header {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 18px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
}

.app-title-block {
    display: flex;
    align-items: center;
    gap: 10px;
}

.app-logo {
    width: 36px;
    height: 36px;
    border-radius: 12px;
    background: radial-gradient(circle at 25% 20%, #4f46e5, #0ea5e9);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #e5e7eb;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
}

.app-title {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 0.01em;
}

.app-subtitle {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
}

.currency-mode-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

.pill-label {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
}

.select-pill {
    position: relative;
    display: inline-flex;
    align-items: center;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(15, 23, 42, 0.8);
    gap: 5px;
}

.select-pill select {
    border: none;
    background: transparent;
    color: var(--text);
    font-size: 12px;
    padding: 2px 2px 2px 0;
    outline: none;
    appearance: none;
    cursor: pointer;
}

.select-pill::after {
    content: "‚ñæ";
    font-size: 9px;
    color: var(--muted);
    pointer-events: none;
}

.mode-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 12px 0 4px;
}

.mode-tab {
    padding: 6px 9px;
    border-radius: 999px;
    font-size: 11px;
    border: 1px solid transparent;
    color: var(--muted);
    background: rgba(15, 23, 42, 0.7);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.16s ease-out;
}

.mode-tab span.icon {
    font-size: 12px;
}

.mode-tab.active {
    color: #e5e7eb;
    border-color: rgba(129, 140, 248, 0.9);
    background: radial-gradient(circle at 0 0, rgba(129, 140, 248, 0.18), rgba(15, 23, 42, 0.9));
    box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
}

.mode-tab:hover:not(.active) {
    border-color: rgba(148, 163, 184, 0.5);
    background: rgba(15, 23, 42, 0.9);
}

.mode-tab:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

.mode-tab:active {
    transform: scale(0.98);
}

.main-layout {
    display: grid;
    grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.1fr);
    gap: 14px;
    margin-top: 10px;
}

@media (max-width: 900px) {
    .main-layout {
        grid-template-columns: minmax(0, 1fr);
    }

    .app-shell {
        padding: 16px;
        border-radius: 16px;
    }

    #sip-swp-app {
        padding: 12px;
    }

    .result-card {
        min-height: 95px;
        padding: 10px 12px 28px;
    }
}

@media (max-width: 680px) {
    .app-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .currency-mode-row {
        width: 100%;
        justify-content: flex-start;
    }

    .mode-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .mode-tabs::-webkit-scrollbar {
        display: none;
    }

    .card {
        padding: 12px;
    }
}

.card {
    background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.25), rgba(15, 23, 42, 0.98));
    border-radius: var(--radius-lg);
    border: 1px solid rgba(55, 65, 81, 0.9);
    padding: 14px;
    box-shadow: var(--shadow-subtle);
}

.card-secondary {
    background: radial-gradient(circle at top right, rgba(15, 118, 110, 0.18), rgba(15, 23, 42, 0.98));
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 10px;
}

.card-title {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: #e5e7eb;
}

.card-subtitle {
    font-size: 11px;
    color: var(--muted);
    margin-top: 2px;
}

.badge {
    font-size: 10px;
    padding: 3px 7px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    color: var(--muted);
    background: rgba(15, 23, 42, 0.85);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.badge-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: radial-gradient(circle at 40% 30%, #a5b4fc, #4f46e5);
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.35);
}

.input-grid {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: 8px;
}

@media (min-width: 680px) {
    .input-grid.two-cols {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

.field-group {
    background: rgba(15, 23, 42, 0.85);
    border-radius: var(--radius-md);
    border: 1px solid var(--input-border);
    padding: 8px 9px 7px;
    position: relative;
    transition: border-color 0.16s ease-out, box-shadow 0.16s ease-out, background 0.16s ease-out;
}

.field-group.focused {
    border-color: var(--input-border-focus);
    box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.65), 0 0 0 10px rgba(79, 70, 229, 0.12);
    background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.5), rgba(15, 23, 42, 0.98));
}

.field-group.invalid {
    border-color: var(--danger);
    box-shadow: 0 0 0 1px rgba(249, 115, 115, 0.5), 0 0 0 10px rgba(249, 115, 115, 0.1);
}

.field-group.invalid .field-label {
    color: var(--danger);
}

.field-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 6px;
}

.field-label {
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 4px;
}

.field-label span.accent {
    color: #a5b4fc;
}

.field-extra {
    font-size: 10px;
    color: var(--muted);
}

.field-input-row {
    margin-top: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.currency-prefix {
    font-size: 13px;
    color: #9ca3af;
    padding: 4px 7px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(55, 65, 81, 0.85);
    min-width: 38px;
    text-align: center;
}

.text-input {
    flex: 1;
    padding: 5px 6px 4px;
    border-radius: 8px;
    border: 1px solid rgba(31, 41, 55, 0.9);
    background: var(--input-bg);
    color: var(--text);
    font-size: 13px;
    outline: none;
    min-height: 30px;
}

.text-input::placeholder {
    color: rgba(107, 114, 128, 0.7);
}

.text-input:focus {
    border-color: var(--input-border-focus);
    box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.6);
    background: #020617;
}

.text-input:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

.suffix {
    font-size: 11px;
    color: var(--muted);
    min-width: 40px;
    text-align: right;
}

.amount-words {
    margin-top: 3px;
    font-size: 10px;
    color: rgba(148, 163, 184, 0.95);
    display: flex;
    align-items: center;
    gap: 6px;
}

.amount-words-tag {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: rgba(148, 163, 184, 0.9);
    padding: 1px 4px;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    background: rgba(15, 23, 42, 0.9);
}

.toggle-row {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

.toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
}

.toggle input {
    display: none;
}

.toggle-pill {
    width: 32px;
    height: 18px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.85);
    border: 1px solid rgba(75, 85, 99, 0.9);
    position: relative;
    transition: all 0.16s ease-out;
}

.toggle-thumb {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    background: #9ca3af;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: all 0.16s ease-out;
    box-shadow: 0 2px 4px rgba(15, 23, 42, 0.6);
}

.toggle input:checked+.toggle-pill {
    background: radial-gradient(circle at 0 0, #4ade80, #15803d);
    border-color: rgba(34, 197, 94, 0.9);
    box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7), 0 0 0 8px rgba(34, 197, 94, 0.25);
}

.toggle input:checked+.toggle-pill .toggle-thumb {
    background: white;
    transform: translateX(12px);
}

.toggle:active .toggle-pill {
    transform: scale(0.95);
}

@media (hover: none) {
    .toggle:hover:not(:active) .toggle-pill {
        background: rgba(15, 23, 42, 0.85);
    }
}

.results-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    margin-bottom: 12px;
}

@media (max-width: 680px) {
    .results-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

.result-card {
    border-radius: var(--radius-md);
    padding: 12px 13px 32px;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
    border: 1px solid rgba(55, 65, 81, 0.9);
    position: relative;
    overflow: visible;
    min-height: 105px;
}

.result-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    line-height: 1.4;
    flex-wrap: wrap;
}

.result-label .separator {
    color: rgba(148, 163, 184, 0.5);
    font-weight: 300;
}

.result-value {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.01em;
    margin-bottom: 8px;
    line-height: 1.5;
    min-height: 24px;
}

.result-tag {
    position: absolute;
    bottom: 10px;
    right: 10px;
    font-size: 9px;
    color: rgba(148, 163, 184, 0.9);
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(55, 65, 81, 0.85);
    background: rgba(15, 23, 42, 0.96);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    z-index: 1;
}

.result-tag-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    flex-shrink: 0;
}

.dot-success {
    background: radial-gradient(circle at 0 0, #6ee7b7, #22c55e);
}

.dot-warning {
    background: radial-gradient(circle at 0 0, #facc15, #eab308);
}

.dot-danger {
    background: radial-gradient(circle at 0 0, #fecaca, #f97373);
}

.dot-neutral {
    background: radial-gradient(circle at 0 0, #e5e7eb, #6b7280);
}

.result-sub {
    font-size: 10px;
    color: var(--muted);
    margin-top: 0;
    margin-bottom: 12px;
    line-height: 1.5;
    padding-right: 75px;
    min-height: 16px;
}

.analysis-card {
    margin-top: 10px;
    border-radius: var(--radius-md);
    background: radial-gradient(circle at top right, rgba(24, 24, 27, 0.98), rgba(15, 23, 42, 0.98));
    border: 1px solid rgba(63, 63, 70, 0.9);
    padding: 12px 13px 11px;
}

.analysis-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(209, 213, 219, 0.9);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    line-height: 1.4;
}

.analysis-title .spark {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 20%, #a5b4fc, #4f46e5);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    box-shadow: 0 8px 20px rgba(79, 70, 229, 0.7);
    flex-shrink: 0;
}

.analysis-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
    gap: 12px;
}

@media (max-width: 780px) {
    .analysis-grid {
        grid-template-columns: minmax(0, 1fr);
        gap: 10px;
    }
}

.analysis-item {
    font-size: 11px;
    color: var(--muted);
    display: flex;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 6px;
    line-height: 1.5;
    align-items: baseline;
}

.analysis-item:last-child {
    margin-bottom: 0;
}

.analysis-item strong {
    color: #e5e7eb;
    font-weight: 500;
    text-align: right;
    flex-shrink: 0;
}

.analysis-section-title {
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 4px;
}

.chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    margin-bottom: 0;
}

.chip {
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 999px;
    border: 1px solid rgba(75, 85, 99, 0.9);
    color: rgba(209, 213, 219, 0.9);
    background: rgba(15, 23, 42, 0.95);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.chip-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
}

.chip-safe {
    background: radial-gradient(circle at 30% 20%, #6ee7b7, #22c55e);
}

.chip-risk {
    background: radial-gradient(circle at 30% 20%, #f97373, #b91c1c);
}

.chip-neutral {
    background: radial-gradient(circle at 30% 20%, #e5e7eb, #6b7280);
}

.segmented {
    display: inline-flex;
    border-radius: 999px;
    border: 1px solid rgba(75, 85, 99, 0.9);
    overflow: hidden;
    background: rgba(15, 23, 42, 0.9);
}

.segmented button {
    border: none;
    background: transparent;
    color: var(--muted);
    font-size: 11px;
    padding: 4px 8px;
    cursor: pointer;
    white-space: nowrap;
}

.segmented button.active {
    background: radial-gradient(circle at 0 0, rgba(79, 70, 229, 0.9), rgba(56, 189, 248, 0.8));
    color: #e5e7eb;
}

.helper {
    font-size: 10px;
    color: var(--muted);
    margin-top: 3px;
}

.hidden {
    display: none !important;
}

/* Theme variants */
#sip-swp-app.theme-light {
    --bg: #f8fafc;
    --bg-alt: #ffffff;
    --card: #ffffff;
    --accent: #4f46e5;
    --accent-soft: rgba(79, 70, 229, 0.1);
    --accent-strong: rgba(79, 70, 229, 0.2);
    --text: #1e293b;
    --muted: #64748b;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #ca8a04;
    --border: #cbd5e1;
    --input-bg: #ffffff;
    --input-border: #cbd5e1;
    --input-border-focus: #4f46e5;
}

#sip-swp-app.theme-light {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    color: var(--text);
}

#sip-swp-app.theme-light .app-shell {
    background: #ffffff;
    border-color: #cbd5e1;
    box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(148, 163, 184, 0.1);
}

#sip-swp-app.theme-light .card {
    background: #ffffff;
    border-color: #e2e8f0;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
}

#sip-swp-app.theme-light .card-secondary {
    background: #f8fafc;
    border-color: #e2e8f0;
}

#sip-swp-app.theme-light .text-input {
    background: #ffffff;
    border-color: #cbd5e1;
    color: var(--text);
}

#sip-swp-app.theme-light .text-input:focus {
    background: #ffffff;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

#sip-swp-app.theme-light .result-card {
    background: #ffffff;
    border-color: #e2e8f0;
    box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
}

#sip-swp-app.theme-light .field-group {
    background: #f8fafc;
    border-color: #e2e8f0;
}

#sip-swp-app.theme-light .field-group.focused {
    background: #ffffff;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

#sip-swp-app.theme-light .mode-tab {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: var(--muted);
}

#sip-swp-app.theme-light .mode-tab.active {
    background: #4f46e5;
    color: #ffffff;
    border-color: #4f46e5;
}

#sip-swp-app.theme-light .mode-tab:hover:not(.active) {
    background: #e2e8f0;
    border-color: #94a3b8;
}

#sip-swp-app.theme-light .analysis-card {
    background: #f8fafc;
    border-color: #e2e8f0;
}

#sip-swp-app.theme-light .schedule-container {
    background: #f8fafc;
    border-color: #e2e8f0;
}

#sip-swp-app.theme-light .schedule-table th {
    background: #f1f5f9;
    color: var(--muted);
    border-bottom-color: #e2e8f0;
}

#sip-swp-app.theme-light .schedule-table td {
    border-bottom-color: #e2e8f0;
    color: var(--text);
}

#sip-swp-app.theme-light .schedule-table tbody tr:hover {
    background: rgba(79, 70, 229, 0.05);
}

#sip-swp-app.theme-light .badge {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: var(--muted);
}

#sip-swp-app.theme-light .chip {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: var(--text);
}

#sip-swp-app.theme-light .segmented {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

#sip-swp-app.theme-light .segmented button.active {
    background: #4f46e5;
    color: #ffffff;
}

#sip-swp-app.theme-light .toggle-pill {
    background: #cbd5e1;
    border-color: #94a3b8;
}

#sip-swp-app.theme-light .toggle input:checked+.toggle-pill {
    background: #16a34a;
    border-color: #16a34a;
}

/* Simple view: hide advanced analysis & schedules */
#sip-swp-app.simple-view .analysis-card,
#sip-swp-app.simple-view .schedule-section,
#sip-swp-app.simple-view .chip-row,
#sip-swp-app.simple-view .helper {
    display: none !important;
}

#sip-swp-app.simple-view .results-grid {
    margin-bottom: 4px;
}

#sip-swp-app.simple-view .badge {
    opacity: 0.7;
}

/* Schedule tables */
.schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 11px;
}

.schedule-table thead {
    background: rgba(15, 23, 42, 0.9);
    border-bottom: 1px solid rgba(55, 65, 81, 0.9);
}

.schedule-table th {
    padding: 8px 6px;
    text-align: left;
    color: var(--muted);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.05em;
}

.schedule-table th:last-child,
.schedule-table td:last-child {
    text-align: right;
}

.schedule-table td {
    padding: 6px;
    color: var(--text);
    border-bottom: 1px solid rgba(55, 65, 81, 0.5);
}

.schedule-table tbody tr:hover {
    background: rgba(79, 70, 229, 0.08);
}

.schedule-table tbody tr:last-child td {
    border-bottom: none;
    font-weight: 600;
    color: var(--text);
    background: rgba(15, 23, 42, 0.6);
}

.schedule-container {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
    border-radius: var(--radius-md);
    border: 1px solid rgba(55, 65, 81, 0.9);
    background: rgba(15, 23, 42, 0.5);
}

.schedule-container::-webkit-scrollbar {
    width: 6px;
}

.schedule-container::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.5);
}

.schedule-container::-webkit-scrollbar-thumb {
    background: rgba(79, 70, 229, 0.5);
    border-radius: 3px;
}

.schedule-container::-webkit-scrollbar-thumb:hover {
    background: rgba(79, 70, 229, 0.7);
}

.schedule-section {
    margin-top: 12px;
}

.schedule-section-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.schedule-section-title .icon {
    font-size: 14px;
}

/* Expense tracking */
.expense-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-list {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 10px;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(55, 65, 81, 0.5);
    margin-bottom: 6px;
    background: rgba(15, 23, 42, 0.5);
    font-size: 11px;
}

.expense-item:hover {
    background: rgba(79, 70, 229, 0.1);
}

.expense-item-left {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.expense-item-category {
    font-weight: 600;
    color: var(--text);
}

.expense-item-date {
    font-size: 10px;
    color: var(--muted);
}

.expense-item-amount {
    font-weight: 600;
    color: var(--danger);
}

.expense-item-actions {
    display: flex;
    gap: 4px;
}

.expense-item-actions button {
    padding: 2px 6px;
    font-size: 10px;
    border: 1px solid rgba(55, 65, 81, 0.5);
    background: rgba(15, 23, 42, 0.7);
    color: var(--muted);
    border-radius: 4px;
    cursor: pointer;
}

.expense-item-actions button:hover {
    background: rgba(79, 70, 229, 0.2);
    color: var(--text);
}

.expense-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    margin-bottom: 12px;
}

.expense-category-breakdown {
    margin-top: 12px;
}

.category-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}

.category-bar-label {
    min-width: 100px;
    font-size: 11px;
    color: var(--muted);
}

.category-bar-fill {
    flex: 1;
    height: 20px;
    background: rgba(79, 70, 229, 0.2);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.category-bar-value {
    height: 100%;
    background: linear-gradient(90deg, #4f46e5, #6366f1);
    transition: width 0.3s ease;
}

.category-bar-amount {
    min-width: 80px;
    text-align: right;
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
}

#sip-swp-app.theme-light .expense-item {
    background: #f8fafc;
    border-color: #e2e8f0;
}

#sip-swp-app.theme-light .expense-item:hover {
    background: rgba(79, 70, 229, 0.05);
}

#sip-swp-app.theme-light .category-bar-fill {
    background: #e2e8f0;
}

/* Loading state */
.calculating {
    opacity: 0.6;
    pointer-events: none;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 20px;
    color: var(--muted);
    font-size: 12px;
}

/* Smooth transitions */
.result-value,
.result-sub,
.analysis-item strong {
    transition: opacity 0.2s ease-out;
}

/* Better touch targets on mobile */
@media (max-width: 680px) {
    .mode-tab {
        padding: 8px 12px;
        min-height: 36px;
    }

    .toggle {
        min-height: 44px;
        padding: 4px 0;
    }

    button,
    .select-pill select {
        min-height: 44px;
    }
}

</style><div class="app-shell"><header class="app-header"><div class="app-title-block"><div class="app-logo">‚Çπ</div><div><div class="app-title">Finance Calculator</div><div class="app-subtitle">SIP ¬∑ Step-up SIP ¬∑ SWP ¬∑ Housing Leverage ¬∑ FD income </div></div></div><div class="currency-mode-row"><div class="select-pill"><span class="pill-label">Currency</span><select id="currencySelect"><option value="INR" selected>‚Çπ INR</option><option value="USD">$ USD</option><option value="EUR">‚Ç¨ EUR</option><option value="AED">ÿØ.ÿ• AED</option><option value="GBP">¬£ GBP</option><option value="SGD">S$ SGD</option><option value="CAD">C$ CAD</option><option value="JPY">¬• JPY</option></select></div><div class="select-pill"><span class="pill-label">Mode</span><select id="primaryModeSelect"><option value="sip-basic" selected>Normal SIP</option><option value="sip-target">Find SIP</option><option value="sip-duration">Find duration</option><option value="sip-roi">Find ROI</option><option value="swp">SWP & FD income</option><option value="amortization">Loan Amortization</option><option value="expenses">Expense Tracker</option><option value="standard">Standard analysis</option></select></div><button id="settingsToggle" class="mode-tab" style="margin-left:auto; padding:5px 9px;"><span class="icon">‚öôÔ∏é</span>Settings </button></div></header><nav class="mode-tabs" id="modeTabs"><button class="mode-tab active" data-mode="sip-basic"><span class="icon">‚Üó</span>Normal SIP </button><button class="mode-tab" data-mode="sip-target"><span class="icon">‚óã</span>Find SIP </button><button class="mode-tab" data-mode="sip-duration"><span class="icon">‚è±</span>Find duration </button><button class="mode-tab" data-mode="sip-roi"><span class="icon">‚ñ¶</span>Find ROI </button><button class="mode-tab" data-mode="swp"><span class="icon">‚¨á</span>SWP & FD </button><button class="mode-tab" data-mode="amortization"><span class="icon">üìã</span>Loan Amortization </button><button class="mode-tab" data-mode="expenses"><span class="icon">üí∞</span>Expense Tracker </button><button class="mode-tab" data-mode="standard"><span class="icon">‚óª</span>House leverage </button></nav><div id="settingsPanel" class="card hidden" style="position:absolute; top:60px; right:20px; max-width:280px; z-index:20;"><div class="card-header"><div><div class="card-title">Settings</div><div class="card-subtitle">Theme,
layout and preferences </div></div></div><div class="input-grid"><div class="field-group"><div class="field-row"><div class="field-label">Theme</div><div class="field-extra">Appearance</div></div><div class="field-input-row"><div class="segmented" id="themeToggle"><button class="active" data-theme="dark">Dark</button><button data-theme="light">Light</button></div></div></div><div class="field-group"><div class="field-row"><div class="field-label">View mode</div><div class="field-extra">Complexity</div></div><div class="field-input-row"><div class="segmented" id="viewModeToggle"><button class="active" data-view="advanced">Advanced</button><button data-view="simple">Simple</button></div></div><div class="helper">Simple hides advanced analysis & schedules for a cleaner view. </div></div></div></div><section class="main-layout"><div><div class="card" id="leftPanel-standard"><div class="card-header"><div><div class="card-title">Standard house & SIP analysis</div><div class="card-subtitle">Standard approach vs leverage+equity investing </div></div><div class="badge"><span class="badge-dot"></span>Live projection </div></div><div class="input-grid"><div class="field-group" data-field="housePrice"><div class="field-row"><div class="field-label">House price <span class="accent">(base)</span></div><div class="field-extra">One-time</div></div><div class="field-input-row"><div class="currency-prefix" id="hpCurrency">‚Çπ</div><input id="housePrice"
class="text-input"
inputmode="numeric"
placeholder="50,00,000"
/></div><div class="amount-words" id="housePriceWords"></div></div><div class="field-group" data-field="years"><div class="field-row"><div class="field-label">Duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="years"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div><div class="helper">Horizon for both home appreciation and investments </div></div><div class="field-group" data-field="middleDown"><div class="field-row"><div class="field-label">Standard downpayment </div><div class="field-extra">Own capital</div></div><div class="field-input-row"><div class="currency-prefix" id="mdCurrency">‚Çπ</div><input id="middleDown"
class="text-input"
inputmode="numeric"
placeholder="40,00,000"
/></div><div class="amount-words" id="middleDownWords"></div></div><div class="field-group" data-field="investorDown"><div class="field-row"><div class="field-label">Investor downpayment </div><div class="field-extra">Leverage mode</div></div><div class="field-input-row"><div class="currency-prefix" id="idCurrency">‚Çπ</div><input id="investorDown"
class="text-input"
inputmode="numeric"
placeholder="5,00,000"
/></div><div class="amount-words" id="investorDownWords"></div></div><div class="field-group" data-field="middleRate"><div class="field-row"><div class="field-label">Standard loan ROI</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="middleRate"
class="text-input"
inputmode="decimal"
placeholder="8.5"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="investorRate"><div class="field-row"><div class="field-label">Investor loan ROI</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="investorRate"
class="text-input"
inputmode="decimal"
placeholder="6.5"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="houseGrowth"><div class="field-row"><div class="field-label">House appreciation </div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="houseGrowth"
class="text-input"
inputmode="decimal"
placeholder="8"
/><div class="suffix">% p.a.</div></div><div class="helper">Long‚Äëterm expected CAGR of the property </div></div><div class="field-group" data-field="equityReturn"><div class="field-row"><div class="field-label">Equity return (lump sum & SIP) </div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="equityReturn"
class="text-input"
inputmode="decimal"
placeholder="12"
/><div class="suffix">% p.a.</div></div><div class="helper">Used for lump sum (investor) and SIP (EMI difference) </div></div></div><div class="toggle-row"><label class="toggle"><input id="enableStepUpStandard" type="checkbox" /><div class="toggle-pill"><div class="toggle-thumb"></div></div><span>Use step‚Äëup SIP for EMI difference</span></label><div class="field-group" style="padding: 4px 8px 4px; min-width: 155px;"><div class="field-row"><div class="field-label">Step‚Äëup</div><div class="field-extra">Annual</div></div><div class="field-input-row"><input id="stepUpPercentStandard"
class="text-input"
inputmode="decimal"
placeholder="10"
style="min-height: 26px; font-size: 12px;"
/><div class="suffix">% p.a.</div></div></div></div></div><div class="card hidden" id="leftPanel-sip-basic"><div class="card-header"><div><div class="card-title">Normal SIP calculator</div><div class="card-subtitle">Monthly SIP with optional step‚Äëup </div></div><div class="badge"><span class="badge-dot"></span>Goal growth </div></div><div class="input-grid two-cols"><div class="field-group" data-field="sipAmount"><div class="field-row"><div class="field-label">Monthly SIP</div><div class="field-extra">Contribution</div></div><div class="field-input-row"><div class="currency-prefix" id="saCurrency">‚Çπ</div><input id="sipAmount"
class="text-input"
inputmode="numeric"
placeholder="25,000"
/></div><div class="amount-words" id="sipAmountWords"></div></div><div class="field-group" data-field="sipYears"><div class="field-row"><div class="field-label">Duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="sipYears"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="sipReturn"><div class="field-row"><div class="field-label">Expected return</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="sipReturn"
class="text-input"
inputmode="decimal"
placeholder="12"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="sipStepUp"><div class="field-row"><div class="field-label">Step‚Äëup SIP</div><div class="field-extra">Optional</div></div><div class="field-input-row"><input id="sipStepUp"
class="text-input"
inputmode="decimal"
placeholder="10"
/><div class="suffix">% p.a.</div></div><div class="helper">Annual increase in monthly contribution </div></div></div><div class="toggle-row"><label class="toggle"><input id="enableStepUpBasic" type="checkbox" /><div class="toggle-pill"><div class="toggle-thumb"></div></div><span>Enable step‚Äëup SIP</span></label></div></div><div class="card hidden" id="leftPanel-sip-target"><div class="card-header"><div><div class="card-title">Find required SIP</div><div class="card-subtitle">Target corpus,
duration and expected return </div></div><div class="badge"><span class="badge-dot"></span>Reverse SIP </div></div><div class="input-grid two-cols"><div class="field-group" data-field="targetCorpus"><div class="field-row"><div class="field-label">Target amount</div><div class="field-extra">Future value</div></div><div class="field-input-row"><div class="currency-prefix" id="tcCurrency">‚Çπ</div><input id="targetCorpus"
class="text-input"
inputmode="numeric"
placeholder="1,00,00,000"
/></div><div class="amount-words" id="targetCorpusWords"></div></div><div class="field-group" data-field="targetYears"><div class="field-row"><div class="field-label">Duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="targetYears"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="targetReturn"><div class="field-row"><div class="field-label">Expected return</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="targetReturn"
class="text-input"
inputmode="decimal"
placeholder="12"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="targetStepUp"><div class="field-row"><div class="field-label">Step‚Äëup SIP</div><div class="field-extra">Optional</div></div><div class="field-input-row"><input id="targetStepUp"
class="text-input"
inputmode="decimal"
placeholder="10"
/><div class="suffix">% p.a.</div></div><div class="helper">If used,
required SIP is starter amount with annual step‚Äëup </div></div></div><div class="toggle-row"><label class="toggle"><input id="enableStepUpTarget" type="checkbox" /><div class="toggle-pill"><div class="toggle-thumb"></div></div><span>Use step‚Äëup SIP</span></label></div></div><div class="card hidden" id="leftPanel-sip-duration"><div class="card-header"><div><div class="card-title">Find duration</div><div class="card-subtitle">How long to reach target with SIP </div></div><div class="badge"><span class="badge-dot"></span>Horizon finder </div></div><div class="input-grid two-cols"><div class="field-group" data-field="durSipAmount"><div class="field-row"><div class="field-label">Monthly SIP</div><div class="field-extra">Fixed</div></div><div class="field-input-row"><div class="currency-prefix" id="daCurrency">‚Çπ</div><input id="durSipAmount"
class="text-input"
inputmode="numeric"
placeholder="25,000"
/></div><div class="amount-words" id="durSipAmountWords"></div></div><div class="field-group" data-field="durTargetCorpus"><div class="field-row"><div class="field-label">Target amount</div><div class="field-extra">Future value</div></div><div class="field-input-row"><div class="currency-prefix" id="dtCurrency">‚Çπ</div><input id="durTargetCorpus"
class="text-input"
inputmode="numeric"
placeholder="1,00,00,000"
/></div><div class="amount-words" id="durTargetCorpusWords"></div></div><div class="field-group" data-field="durReturn"><div class="field-row"><div class="field-label">Expected return</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="durReturn"
class="text-input"
inputmode="decimal"
placeholder="12"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="durStepUp"><div class="field-row"><div class="field-label">Step‚Äëup SIP</div><div class="field-extra">Optional</div></div><div class="field-input-row"><input id="durStepUp"
class="text-input"
inputmode="decimal"
placeholder="10"
/><div class="suffix">% p.a.</div></div><div class="helper">Approximate for step‚Äëup;
exact for plain SIP </div></div></div><div class="toggle-row"><label class="toggle"><input id="enableStepUpDur" type="checkbox" /><div class="toggle-pill"><div class="toggle-thumb"></div></div><span>Use step‚Äëup SIP</span></label></div></div><div class="card hidden" id="leftPanel-sip-roi"><div class="card-header"><div><div class="card-title">Find required ROI</div><div class="card-subtitle">Return needed to hit goal with your SIP </div></div><div class="badge"><span class="badge-dot"></span>Stretch vs realistic </div></div><div class="input-grid two-cols"><div class="field-group" data-field="roiSipAmount"><div class="field-row"><div class="field-label">Monthly SIP</div><div class="field-extra">Fixed</div></div><div class="field-input-row"><div class="currency-prefix" id="raCurrency">‚Çπ</div><input id="roiSipAmount"
class="text-input"
inputmode="numeric"
placeholder="25,000"
/></div><div class="amount-words" id="roiSipAmountWords"></div></div><div class="field-group" data-field="roiTargetCorpus"><div class="field-row"><div class="field-label">Target amount</div><div class="field-extra">Future value</div></div><div class="field-input-row"><div class="currency-prefix" id="rtCurrency">‚Çπ</div><input id="roiTargetCorpus"
class="text-input"
inputmode="numeric"
placeholder="1,00,00,000"
/></div><div class="amount-words" id="roiTargetCorpusWords"></div></div><div class="field-group" data-field="roiYears"><div class="field-row"><div class="field-label">Duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="roiYears"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="roiStepUp"><div class="field-row"><div class="field-label">Step‚Äëup SIP</div><div class="field-extra">Optional</div></div><div class="field-input-row"><input id="roiStepUp"
class="text-input"
inputmode="decimal"
placeholder="10"
/><div class="suffix">% p.a.</div></div><div class="helper">Approximate for step‚Äëup;
exact for plain SIP </div></div></div><div class="toggle-row"><label class="toggle"><input id="enableStepUpRoi" type="checkbox" /><div class="toggle-pill"><div class="toggle-thumb"></div></div><span>Use step‚Äëup SIP</span></label></div></div><div class="card card-secondary hidden" id="leftPanel-swp"><div class="card-header"><div><div class="card-title">SWP & FD income planner</div><div class="card-subtitle">Principal protection,
exhaustion and required corpus </div></div><div class="badge"><span class="badge-dot"></span>Retirement cash‚Äëflow </div></div><div class="toggle-row" style="margin-bottom: 5px;"><div class="segmented" id="swpModeToggle"><button class="active" data-swp-mode="fromCorpus">From corpus </button><button data-swp-mode="requiredCorpus">Required corpus </button></div><div class="field-group" style="padding: 4px 8px 4px; min-width: 175px;"><div class="field-row"><div class="field-label">Frequency</div><div class="field-extra">Withdrawals</div></div><div class="field-input-row"><select id="swpFrequency"
class="text-input"
style="padding-right: 22px; appearance: none; cursor: pointer; min-height: 26px; font-size: 12px;"
><option value="12">Monthly</option><option value="4">Quarterly</option><option value="2">Half‚Äëyearly</option><option value="1">Yearly</option></select><div class="suffix">Payout</div></div></div></div><div class="input-grid two-cols" id="swpFromCorpusInputs"><div class="field-group" data-field="swpCorpus"><div class="field-row"><div class="field-label">Starting corpus</div><div class="field-extra">Invested</div></div><div class="field-input-row"><div class="currency-prefix" id="scCurrency">‚Çπ</div><input id="swpCorpus"
class="text-input"
inputmode="numeric"
placeholder="50,00,000"
/></div><div class="amount-words" id="swpCorpusWords"></div></div><div class="field-group" data-field="swpDuration"><div class="field-row"><div class="field-label">Planned duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="swpDuration"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="swpReturn"><div class="field-row"><div class="field-label">Return on corpus</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="swpReturn"
class="text-input"
inputmode="decimal"
placeholder="7"
/><div class="suffix">% p.a.</div></div><div class="helper">FD,
debt fund or balanced portfolio assumption </div></div><div class="field-group" data-field="swpWithdrawal"><div class="field-row"><div class="field-label">Desired withdrawal</div><div class="field-extra">Per period</div></div><div class="field-input-row"><div class="currency-prefix" id="swCurrency">‚Çπ</div><input id="swpWithdrawal"
class="text-input"
inputmode="numeric"
placeholder="40,000"
/></div><div class="amount-words" id="swpWithdrawalWords"></div></div></div><div class="input-grid two-cols hidden" id="swpRequiredCorpusInputs"><div class="field-group" data-field="swpReqWithdrawal"><div class="field-row"><div class="field-label">Target withdrawal</div><div class="field-extra">Per period</div></div><div class="field-input-row"><div class="currency-prefix" id="srwCurrency">‚Çπ</div><input id="swpReqWithdrawal"
class="text-input"
inputmode="numeric"
placeholder="40,000"
/></div><div class="amount-words" id="swpReqWithdrawalWords"></div></div><div class="field-group" data-field="swpReqDuration"><div class="field-row"><div class="field-label">Planned duration</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="swpReqDuration"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="swpReqReturn"><div class="field-row"><div class="field-label">Return on corpus</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="swpReqReturn"
class="text-input"
inputmode="decimal"
placeholder="7"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="swpReqStyle"><div class="field-row"><div class="field-label">Style</div><div class="field-extra">Corpus behaviour</div></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Principal protection </div><div class="chip"><span class="chip-dot chip-neutral"></span>Sustainable (buffer left) </div><div class="chip"><span class="chip-dot chip-risk"></span>Full exhaustion </div></div></div></div><div class="helper">FD comparison panel on the right shows monthly,
quarterly,
half‚Äëyearly and yearly interest flows for your corpus. </div></div></div><div><div class="card" id="rightPanel-standard"><div class="card-header"><div><div class="card-title">House & investment outcomes</div><div class="card-subtitle">Standard vs investor+equity & SIP overlay </div></div><div class="badge"><span class="badge-dot"></span>Full 360¬∞ picture </div></div><div class="results-grid" id="standardTopResults"><div class="result-card"><div class="result-label"><span>Standard EMI</span><span class="separator">/</span><span>Month</span></div><div class="result-value" id="middleEmiDisplay">‚Çπ0</div><div class="result-sub">Total interest: <span id="middleInterestDisplay">‚Çπ0</span></div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Higher own capital </div></div><div class="result-card"><div class="result-label"><span>Investor EMI</span><span class="separator">/</span><span>Month</span></div><div class="result-value" id="investorEmiDisplay">‚Çπ0</div><div class="result-sub">Total interest: <span id="investorInterestDisplay">‚Çπ0</span></div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Higher leverage </div></div><div class="result-card"><div class="result-label"><span>House Value</span><span class="separator">‚Ä¢</span><span>Appreciated</span></div><div class="result-value" id="houseFutureValueDisplay">‚Çπ0</div><div class="result-sub">CAGR: <span id="houseCagrDisplay">0%</span></div><div class="result-tag"><span class="result-tag-dot dot-success"></span>Property growth </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚àß</span>Capital efficiency & equity overlay </div><div class="analysis-grid"><div><div class="analysis-section-title">Standard scenario</div><div class="analysis-item"><span>Standard net gain from house</span><span><strong id="middleHouseGainDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Standard ROI on downpayment</span><span><strong id="middleRoiDisplay">0%</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Leverage multiplies % </div><div class="chip"><span class="chip-dot chip-neutral"></span>Absolute ‚Çπ still matters </div></div></div><div><div class="analysis-section-title">Investor scenario</div><div class="analysis-item"><span>Investor net gain from house</span><span><strong id="investorHouseGainDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Investor ROI on downpayment</span><span><strong id="investorRoiDisplay">0%</strong></span></div><div class="analysis-item"><span>Investor lump‚Äësum into equity</span><span><strong id="investorEquityFutureDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>EMI difference invested as SIP</span><span><strong id="emiSipFutureDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Total standard wealth (approx)</span><span><strong id="middleTotalWealthDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Total investor wealth (approx)</span><span><strong id="investorTotalWealthDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>EMI diff ‚Üí SIP compounds </div><div class="chip"><span class="chip-dot chip-risk"></span>Equity higher volatility </div></div></div></div></div></div><div class="card hidden" id="rightPanel-sip-basic"><div class="card-header"><div><div class="card-title">SIP maturity details</div><div class="card-subtitle">Plain vs step‚Äëup;
contribution vs growth </div></div><div class="badge"><span class="badge-dot"></span>Compounding engine </div></div><div class="results-grid"><div class="result-card"><div class="result-label"><span>Total Invested</span><span class="separator">‚Ä¢</span><span>Principal</span></div><div class="result-value" id="sipTotalInvestedDisplay">‚Çπ0</div><div class="result-sub">Months: <span id="sipMonthsDisplay">0</span></div><div class="result-tag"><span class="result-tag-dot dot-neutral"></span>Your savings </div></div><div class="result-card"><div class="result-label"><span>Wealth Created</span><span class="separator">‚Ä¢</span><span>Future Value</span></div><div class="result-value" id="sipMaturityDisplay">‚Çπ0</div><div class="result-sub">Gain: <span id="sipGainDisplay">‚Çπ0</span></div><div class="result-tag"><span class="result-tag-dot dot-success"></span>Compounding effect </div></div><div class="result-card"><div class="result-label"><span>Effective CAGR</span><span class="separator">‚Ä¢</span><span>On Contributions</span></div><div class="result-value" id="sipCagrDisplay">0%</div><div class="result-sub">Step‚Äëup boosts front‚Äëloading </div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Realistic vs goal </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚àû</span>SIP habit quality snapshot </div><div class="analysis-grid"><div><div class="analysis-item"><span>Plain SIP maturity</span><span><strong id="sipPlainMaturityDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Step‚Äëup SIP maturity</span><span><strong id="sipStepMaturityDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Extra created due to step‚Äëup</span><span><strong id="sipExtraStepDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Income growing? Use step‚Äëup </div><div class="chip"><span class="chip-dot chip-neutral"></span>Automation beats timing </div></div></div><div><div class="analysis-item"><span>Average monthly investment</span><span><strong id="sipAvgMonthlyDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Wealth multiple</span><span><strong id="sipWealthMultipleDisplay">0x</strong></span></div><div class="analysis-item"><span>Approx ‚Çπ per year of waiting</span><span><strong id="sipDelayCostDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-risk"></span>Delaying reduces power </div><div class="chip"><span class="chip-dot chip-safe"></span>Start small,
grow later </div></div></div></div></div><div class="schedule-section"><div class="schedule-section-title"><span class="icon">üìä</span><span>SIP Breakdown Schedule</span></div><div style="margin-bottom: 12px;"><div class="schedule-section-title" style="font-size: 11px; margin-bottom: 6px;"><span>Without Step-up</span></div><div class="schedule-container" id="sipBreakdownContainerPlain"><table class="schedule-table" id="sipBreakdownTablePlain"><thead><tr><th>Year</th><th>Month</th><th>Investment</th><th>Value</th></tr></thead><tbody id="sipBreakdownBodyPlain"></tbody></table></div></div><div><div class="schedule-section-title" style="font-size: 11px; margin-bottom: 6px;"><span>With Step-up</span></div><div class="schedule-container" id="sipBreakdownContainerStep"><table class="schedule-table" id="sipBreakdownTableStep"><thead><tr><th>Year</th><th>Month</th><th>Investment</th><th>Value</th></tr></thead><tbody id="sipBreakdownBodyStep"></tbody></table></div></div></div></div><div class="card hidden" id="rightPanel-sip-target"><div class="card-header"><div><div class="card-title">Required SIP analysis</div><div class="card-subtitle">How aggressive you need to be for the goal </div></div><div class="badge"><span class="badge-dot"></span>Goal planner </div></div><div class="results-grid"><div class="result-card"><div class="result-label"><span>Required SIP</span><span class="separator">/</span><span>Month</span></div><div class="result-value" id="reqSipDisplay">‚Çπ0</div><div class="result-sub">With or without step‚Äëup </div><div class="result-tag"><span class="result-tag-dot dot-success"></span>Action number </div></div><div class="result-card"><div class="result-label"><span>Total Investable</span><span class="separator">‚Ä¢</span><span>Over Horizon</span></div><div class="result-value" id="reqTotalInvestDisplay">‚Çπ0</div><div class="result-sub">Months: <span id="reqMonthsDisplay">0</span></div><div class="result-tag"><span class="result-tag-dot dot-neutral"></span>Savings needed </div></div><div class="result-card"><div class="result-label"><span>Wealth Multiple</span><span class="separator">‚Ä¢</span><span>Goal / Invested</span></div><div class="result-value" id="reqWealthMultipleDisplay">0x</div><div class="result-sub">Higher multiple ‚Üí more market help </div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Ambition level </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚óã</span>Feasibility & stretch check </div><div class="analysis-grid"><div><div class="analysis-item"><span>Required SIP as % of income*</span><span><strong id="reqSipIncomePctDisplay">‚Äì</strong></span></div><div class="analysis-item"><span>Suggested comfortable zone</span><span><strong>20‚Äì30%</strong></span></div><div class="analysis-item"><span>Is this goal realistic?</span><span><strong id="reqRealisticFlag">Depends</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Within 20‚Äì30%: balanced </div><div class="chip"><span class="chip-dot chip-risk"></span>Above 40%: aggressive </div></div></div><div><div class="analysis-item"><span>If SIP reduced 20%</span><span><strong id="reqFutureIfReducedDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>If duration extended 5 yrs</span><span><strong id="reqSipIfExtra5YrDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>If return 2% lower</span><span><strong id="reqSipIfLowerReturnDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-neutral"></span>Use tenure as safety valve </div><div class="chip"><span class="chip-dot chip-safe"></span>Start higher ‚Üí can reduce later </div></div></div></div></div></div><div class="card hidden" id="rightPanel-sip-duration"><div class="card-header"><div><div class="card-title">Time to goal analysis</div><div class="card-subtitle">How long your SIP likely needs to run </div></div><div class="badge"><span class="badge-dot"></span>Horizon sense‚Äëcheck </div></div><div class="results-grid"><div class="result-card"><div class="result-label"><span>Estimated Duration</span><span class="separator">‚Ä¢</span><span>Years</span></div><div class="result-value" id="durYearsDisplay">0 yrs</div><div class="result-sub">Months: <span id="durMonthsDisplay">0</span></div><div class="result-tag"><span class="result-tag-dot dot-success"></span>Patience required </div></div><div class="result-card"><div class="result-label"><span>Total Invested</span><span class="separator">‚Ä¢</span><span>Principal</span></div><div class="result-value" id="durTotalInvestedDisplay">‚Çπ0</div><div class="result-sub">With or without step‚Äëup </div><div class="result-tag"><span class="result-tag-dot dot-neutral"></span>Skin in the game </div></div><div class="result-card"><div class="result-label"><span>Wealth Multiple</span><span class="separator">‚Ä¢</span><span>Goal / Invested</span></div><div class="result-value" id="durWealthMultipleDisplay">0x</div><div class="result-sub">Helps compare alternatives </div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Trade‚Äëoff lens </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚è±</span>Time vs contribution trade‚Äëoffs </div><div class="analysis-grid"><div><div class="analysis-item"><span>If you increase SIP 20%</span><span><strong id="durYearsIfHigherSipDisplay">0 yrs</strong></span></div><div class="analysis-item"><span>If returns 2% higher</span><span><strong id="durYearsIfHigherReturnDisplay">0 yrs</strong></span></div><div class="analysis-item"><span>If returns 2% lower</span><span><strong id="durYearsIfLowerReturnDisplay">0 yrs</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Contribution ‚Üë beats chasing returns </div></div></div><div><div class="analysis-item"><span>Delay starting by 3 yrs</span><span><strong id="durLossIfDelayDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Goal achievable before X age?</span><span><strong id="durAgeFlagDisplay">Plan around life goals</strong></span></div><div class="analysis-item"><span>Suggested review interval</span><span><strong>Every 12‚Äì18 months</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-neutral"></span>Re‚Äëplan as income changes </div></div></div></div></div></div><div class="card hidden" id="rightPanel-sip-roi"><div class="card-header"><div><div class="card-title">Required ROI analysis</div><div class="card-subtitle">Are expectations aligned with reality? </div></div><div class="badge"><span class="badge-dot"></span>Expectations vs history </div></div><div class="results-grid"><div class="result-card"><div class="result-label"><span>Required CAGR</span><span class="separator">/</span><span>Year</span></div><div class="result-value" id="roiRequiredDisplay">0%</div><div class="result-sub">Plain SIP equivalent rate </div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Stretch number </div></div><div class="result-card"><div class="result-label"><span>Realistic Band</span><span class="separator">‚Ä¢</span><span>Equity SIP</span></div><div class="result-value">10‚Äì14%</div><div class="result-sub">Over 15+years,
not guaranteed </div><div class="result-tag"><span class="result-tag-dot dot-neutral"></span>Historical hint </div></div><div class="result-card"><div class="result-label"><span>Risk Flag</span><span class="separator">‚Ä¢</span><span>Market Dependent</span></div><div class="result-value" id="roiRiskFlagDisplay">Moderate </div><div class="result-sub">Higher required CAGR ‚Üí higher risk </div><div class="result-tag"><span class="result-tag-dot dot-danger"></span>Behaviour important </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚îÇ</span>Adjust knobs to make goal healthier </div><div class="analysis-grid"><div><div class="analysis-item"><span>If SIP increased 20%</span><span><strong id="roiIfHigherSipDisplay">0%</strong></span></div><div class="analysis-item"><span>If duration extended 5 yrs</span><span><strong id="roiIfLongerTenorDisplay">0%</strong></span></div><div class="analysis-item"><span>If goal reduced 20%</span><span><strong id="roiIfLowerGoalDisplay">0%</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>First tweak SIP & tenure </div></div></div><div><div class="analysis-item"><span>Portion in safer assets</span><span><strong>10‚Äì30%</strong></span></div><div class="analysis-item"><span>Rebalancing frequency</span><span><strong>Once a year</strong></span></div><div class="analysis-item"><span>Behaviour gap reminder</span><span><strong>Sticking>picking</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-neutral"></span>Planning>prediction </div></div></div></div></div></div><div class="card card-secondary hidden" id="rightPanel-swp"><div class="card-header"><div><div class="card-title">SWP & FD outcome view</div><div class="card-subtitle">Maximum safe withdrawal,
exhaustion and FD flows </div></div><div class="badge"><span class="badge-dot"></span>Income lens </div></div><div class="results-grid"><div class="result-card"><div class="result-label"><span>Max Safe Withdrawal</span><span class="separator">‚Ä¢</span><span>Corpus Intact</span></div><div class="result-value" id="swpMaxSafeDisplay">‚Çπ0</div><div class="result-sub">Uses only interest;
deposit stays intact </div><div class="result-tag"><span class="result-tag-dot dot-success"></span>Principal protection </div></div><div class="result-card"><div class="result-label"><span>Withdrawal for full exhaustion</span><span>Corpus ‚Üí 0 at end</span></div><div class="result-value" id="swpExhaustWithdrawalDisplay">‚Çπ0</div><div class="result-sub">Fixed payout to exactly finish corpus </div><div class="result-tag"><span class="result-tag-dot dot-warning"></span>Drawdown mode </div></div><div class="result-card"><div class="result-label"><span>Corpus life with current withdrawal</span><span>Vs planned duration</span></div><div class="result-value" id="swpCorpusLifeDisplay">0 yrs </div><div class="result-sub">Status: <span id="swpSustainabilityFlag">‚Äì</span></div><div class="result-tag"><span class="result-tag-dot dot-danger"></span>Sustainability </div></div></div><div class="analysis-card"><div class="analysis-title"><span class="spark">‚óá</span>FD interest flows & corpus behaviour </div><div class="analysis-grid"><div><div class="analysis-item"><span>FD monthly interest (approx)</span><span><strong id="fdMonthlyDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>FD quarterly interest</span><span><strong id="fdQuarterlyDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>FD half‚Äëyearly interest</span><span><strong id="fdHalfYearlyDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>FD yearly interest</span><span><strong id="fdYearlyDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>FD=predictable cash‚Äëflow </div><div class="chip"><span class="chip-dot chip-risk"></span>But may lag inflation </div></div></div><div><div class="analysis-item"><span>Total withdrawals over horizon</span><span><strong id="swpTotalWithdrawalsDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Corpus at end (current plan)</span><span><strong id="swpEndCorpusDisplay">‚Çπ0</strong></span></div><div class="analysis-item"><span>Required corpus for target SWP</span><span><strong id="swpReqCorpusDisplay">‚Çπ0</strong></span></div><div class="chip-row"><div class="chip"><span class="chip-dot chip-safe"></span>Use principal‚Äëprotected number as baseline </div><div class="chip"><span class="chip-dot chip-neutral"></span>Exhaustion strategy for late‚Äëlife use </div></div></div></div></div></div><div class="card hidden" id="leftPanel-amortization"><div class="card-header"><div><div class="card-title">Loan Amortization Calculator</div><div class="card-subtitle">Monthly payment breakdown with principal & interest </div></div><div class="badge"><span class="badge-dot"></span>Payment schedule </div></div><div class="input-grid two-cols"><div class="field-group" data-field="amortPrincipal"><div class="field-row"><div class="field-label">Loan Amount</div><div class="field-extra">Principal</div></div><div class="field-input-row"><div class="currency-prefix" id="amortPrincipalCurrency">‚Çπ</div><input id="amortPrincipal"
class="text-input"
inputmode="numeric"
placeholder="50,00,000"
/></div><div class="amount-words" id="amortPrincipalWords"></div></div><div class="field-group" data-field="amortRate"><div class="field-row"><div class="field-label">Interest Rate</div><div class="field-extra">Per year</div></div><div class="field-input-row"><input id="amortRate"
class="text-input"
inputmode="decimal"
placeholder="8.5"
/><div class="suffix">% p.a.</div></div></div><div class="field-group" data-field="amortYears"><div class="field-row"><div class="field-label">Loan Tenure</div><div class="field-extra">Years</div></div><div class="field-input-row"><input id="amortYears"
class="text-input"
inputmode="numeric"
placeholder="20"
/><div class="suffix">Years</div></div></div><div class="field-group" data-field="amortType"><div class="field-row"><div class="field-label">Interest type</div><div class="field-extra">Structure</div></div><div class="field-input-row"><select id="amortType"
class="text-input"
style="padding-right: 22px; appearance: none; cursor: pointer; min-height: 26px; font-size: 12px;"
><option value="reducing" selected>Reducing (EMI)</option><option value="flat">Flat / simple interest</option><option value="interest-only">Interest-only</option></select><div class="suffix">Mode</div></div><div class="helper">Floating vs fixed can be modelled via different rate assumptions over time. </div></div></div></div><div class="card hidden" id="rightPanel-amortization"><div class="card-header"><div><div class="card-title">Amortization Schedule</div><div class="card-subtitle">Complete payment breakdown over loan tenure </div></div><div class="badge"><span class="badge-dot"></span>Payment details </div></div><div class="results-grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); margin-bottom: 12px;"><div class="result-card"><div class="result-label"><span>Monthly EMI</span></div><div class="result-value" id="amortEmiDisplay">‚Çπ0</div></div><div class="result-card"><div class="result-label"><span>Total Interest</span></div><div class="result-value" id="amortTotalInterestDisplay">‚Çπ0</div></div><div class="result-card"><div class="result-label"><span>Total Payment</span></div><div class="result-value" id="amortTotalPaymentDisplay">‚Çπ0</div></div><div class="result-card"><div class="result-label"><span>Total Months</span></div><div class="result-value" id="amortTotalMonthsDisplay">0</div></div></div><div class="schedule-section"><div class="schedule-section-title" style="justify-content: space-between;"><div style="display:flex; align-items:center; gap:6px;"><span class="icon">üìã</span><span>Payment Schedule</span></div><div class="segmented" id="amortFreqToggle"><button class="active" data-amort-freq="monthly">Monthly</button><button data-amort-freq="yearly">Yearly</button></div></div><div class="schedule-container" id="amortizationContainer"><table class="schedule-table" id="amortizationTable"><thead><tr><th id="amortPeriodHeader">Month</th><th>EMI</th><th>Principal</th><th>Interest</th><th>Balance</th></tr></thead><tbody id="amortizationBody"></tbody></table></div></div></div><div class="card hidden" id="leftPanel-expenses"><div class="card-header"><div><div class="card-title">Expense Tracker</div><div class="card-subtitle">Track daily expenses and view statistics </div></div><div class="badge"><span class="badge-dot"></span>Daily tracking </div></div><div class="expense-form"><div class="field-group" data-field="expenseAmount"><div class="field-row"><div class="field-label">Amount</div><div class="field-extra">Spent</div></div><div class="field-input-row"><div class="currency-prefix" id="expenseAmountCurrency">‚Çπ</div><input id="expenseAmount"
class="text-input"
inputmode="numeric"
placeholder="500"
/></div></div><div class="field-group" data-field="expenseCategory"><div class="field-row"><div class="field-label">Category</div><div class="field-extra">Type</div></div><div class="field-input-row"><select id="expenseCategory"
class="text-input"
style="padding-right: 22px; appearance: none; cursor: pointer; min-height: 26px; font-size: 12px;"
><option value="Food">Food & Dining</option><option value="Transport">Transportation</option><option value="Shopping">Shopping</option><option value="Bills">Bills & Utilities</option><option value="Entertainment">Entertainment</option><option value="Health">Health & Medical</option><option value="Education">Education</option><option value="Travel">Travel</option><option value="Other">Other</option></select><div class="suffix">Type</div></div></div><div class="field-group" data-field="expenseDate"><div class="field-row"><div class="field-label">Date</div><div class="field-extra">When</div></div><div class="field-input-row"><input id="expenseDate"
class="text-input"
type="date"
style="min-height: 26px; font-size: 12px;"
/></div></div><div class="field-group" data-field="expenseDescription"><div class="field-row"><div class="field-label">Description</div><div class="field-extra">Optional</div></div><div class="field-input-row"><input id="expenseDescription"
class="text-input"
placeholder="Brief description"
style="min-height: 26px; font-size: 12px;"
/></div></div><button id="addExpenseBtn"
class="mode-tab"
style="width: 100%; justify-content: center; margin-top: 8px; padding: 8px 12px;"

><span class="icon">+</span>Add Expense </button></div></div><div class="card hidden" id="rightPanel-expenses"><div class="card-header"><div><div class="card-title">Expense Statistics</div><div class="card-subtitle">Overview and category breakdown </div></div><div class="badge"><span class="badge-dot"></span>Insights </div></div><div class="expense-stats-grid"><div class="result-card"><div class="result-label"><span>Total Expenses</span></div><div class="result-value" id="expenseTotalDisplay">‚Çπ0</div><div class="result-sub">All time </div></div><div class="result-card"><div class="result-label"><span>This Month</span></div><div class="result-value" id="expenseMonthDisplay">‚Çπ0</div><div class="result-sub">Current month </div></div><div class="result-card"><div class="result-label"><span>Daily Average</span></div><div class="result-value" id="expenseDailyAvgDisplay">‚Çπ0</div><div class="result-sub">Per day </div></div><div class="result-card"><div class="result-label"><span>Total Entries</span></div><div class="result-value" id="expenseCountDisplay">0</div><div class="result-sub">Records </div></div></div><div class="expense-category-breakdown"><div class="schedule-section-title"><span class="icon">üìä</span><span>Category Breakdown</span></div><div id="expenseCategoryBreakdown"><div class="empty-state">No expenses added yet</div></div></div><div class="schedule-section"><div class="schedule-section-title"><span class="icon">üìã</span><span>Recent Expenses</span></div><div class="expense-list" id="expenseList"><div class="empty-state">No expenses added yet</div></div></div></div></div></section></div><script>(function () {
        const currencyConfig= {
            INR: {
                symbol: "‚Çπ", decimals: 0, indian: true, name: "Rupees"
            }

            ,
            USD: {
                symbol: "$", decimals: 2, indian: false, name: "Dollars"
            }

            ,
            EUR: {
                symbol: "‚Ç¨", decimals: 2, indian: false, name: "Euros"
            }

            ,
            AED: {
                symbol: "ÿØ.ÿ•", decimals: 2, indian: false, name: "Dirhams"
            }

            ,
            GBP: {
                symbol: "¬£", decimals: 2, indian: false, name: "Pounds"
            }

            ,
            SGD: {
                symbol: "S$", decimals: 2, indian: false, name: "Dollars"
            }

            ,
            CAD: {
                symbol: "C$", decimals: 2, indian: false, name: "Dollars"
            }

            ,
            JPY: {
                symbol: "¬•", decimals: 0, indian: false, name: "Yen"
            }

            ,
        }

        ;

        let currentCurrency="INR";
        let recalcTimeout=null;
        const appRoot=document.getElementById("sip-swp-app");

        let currentTheme="dark";
        let simpleView=false;

        try {
            const storedTheme=window.localStorage.getItem("financeCalcTheme");

            if (storedTheme==="light" || storedTheme==="dark") {
                currentTheme=storedTheme;
            }

            const storedView=window.localStorage.getItem("financeCalcView");

            if (storedView==="simple" || storedView==="advanced") {
                simpleView=storedView==="simple";
            }
        }

        catch (e) {
            // ignore storage errors
        }

        // Debounce function for calculations
        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later=()=> {
                    clearTimeout(recalcTimeout);
                    func(...args);
                }

                ;
                clearTimeout(recalcTimeout);
                recalcTimeout=setTimeout(later, wait);
            }

            ;
        }

        function parseNumber(str) {
            if ( !str) return 0;
            const cleaned=String(str).replace(/, /g, "").trim();
            const val=parseFloat(cleaned);
            return isNaN(val) || !isFinite(val) ? 0 : Math.max(0, val);
        }

        function validateInput(value, min=0, max=Infinity, fieldName="") {
            if (value < min) return {
                valid: false, error: `$ {
                    fieldName
                }

                must be at least $ {
                    min
                }

                `
            }

            ;

            if (value > max) return {
                valid: false, error: `$ {
                    fieldName
                }

                exceeds maximum $ {
                    max
                }

                `
            }

            ;

            if ( !isFinite(value)) return {
                valid: false, error: `$ {
                    fieldName
                }

                must be a valid number`
            }

            ;

            return {
                valid: true, error: null
            }

            ;
        }

        function applyTheme(theme) {
            currentTheme=theme==="light" ? "light" : "dark";

            if (currentTheme==="light") {
                appRoot.classList.add("theme-light");
            }

            else {
                appRoot.classList.remove("theme-light");
            }

            try {
                window.localStorage.setItem("financeCalcTheme", currentTheme);
            }

            catch (e) {}

            const themeToggle=document.getElementById("themeToggle");

            if (themeToggle) {
                themeToggle .querySelectorAll("button") .forEach((btn)=> btn.classList.toggle("active", btn.dataset.theme===currentTheme));
            }
        }

        function applyViewMode(mode) {
            simpleView=mode==="simple";
            appRoot.classList.toggle("simple-view", simpleView);

            try {
                window.localStorage.setItem("financeCalcView",
                    simpleView ? "simple" : "advanced"
                );
            }

            catch (e) {}

            const viewToggle=document.getElementById("viewModeToggle");

            if (viewToggle) {
                viewToggle .querySelectorAll("button") .forEach((btn)=> btn.classList.toggle("active", btn.dataset.view===(simpleView ? "simple" : "advanced")));
            }
        }

        function formatIndian(num, decimals) {
            const fixed=num.toFixed(decimals);
            const parts=fixed.split(".");
            let x=parts[0];
            const lastThree=x.slice(-3);
            const other=x.slice(0, -3);

            if (other !=="") x=other.replace(/\B(?=(\d {
                            2
                        })+(? !\d))/g, ",") + "," + lastThree;
            return parts.length > 1 && decimals > 0 ? x + "." + parts[1] : x;
        }

        function formatNumber(num, currencyCode, withSymbol=true) {
            const cfg=currencyConfig[currencyCode || currentCurrency] || currencyConfig.INR;
            const decimals=cfg.decimals;
            if ( !isFinite(num) || isNaN(num)) return withSymbol ? cfg.symbol + "0" : "0";
            // Handle very large numbers
            if (Math.abs(num) > 1e15) return withSymbol ? cfg.symbol + "‚àû" : "‚àû";
            const abs=Math.abs(num);
            const sign=num < 0 ? "-" : "";
            let body;

            if (cfg.indian) {
                body=formatIndian(abs, decimals);
            }

            else {
                body=abs.toLocaleString("en-US", {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals,
                });
        }

        return (withSymbol ? cfg.symbol : "") + sign + body;
    }

    function formatInputWithCommas(input) {
        const raw=input.value;
        const cfg=currencyConfig[currentCurrency] || currencyConfig.INR;
        // Allow decimals for percentage/rate fields (inputmode="decimal")
        const allowsDecimals=input.getAttribute("inputmode")==="decimal";
        const decimals=allowsDecimals ? 2 : cfg.decimals;
        const cleaned=raw.replace(/, /g, "").replace(/[^\d.]/g, "");

        if ( !cleaned) {
            input.dataset.raw="";
            input.value="";
            return;
        }

        let parts=cleaned.split(".");
        let intPart=parts[0];
        let decPart=parts[1] || "";
        // Check if user is in the middle of typing a decimal (e.g., "12.")
        const hasTrailingDot=raw.trim().endsWith (".") && cleaned.includes(".");

        if (decimals===0 && !allowsDecimals) {
            decPart="";
        }

        else if (decPart.length > decimals) {
            decPart=decPart.slice(0, decimals);
        }

        const num=parseFloat(intPart + (decPart ? "." + decPart : ""));

        if (isNaN(num) && intPart==="") {
            input.dataset.raw="";
            input.value="";
            return;
        }

        // Preserve the number even if it's just "0" or empty intPart
        const finalNum=isNaN(num) ? 0 : num;
        input.dataset.raw=String(finalNum);
        let formattedInt;

        if (cfg.indian) {
            formattedInt=formatIndian(Number(intPart || "0"), 0);
        }

        else {
            formattedInt=Number(intPart || "0").toLocaleString("en-US", {
                maximumFractionDigits: 0,
            });
    }

    // Preserve trailing dot if user just typed it
    if (hasTrailingDot && allowsDecimals && !decPart) {
        input.value=formattedInt + ".";
    }

    else {
        input.value=formattedInt + (decPart && (decimals > 0 || allowsDecimals) ? "." + decPart : "");
    }
}

function numberToWords(num, currencyCode) {
    num=Math.floor(num);
    if (num===0) return "zero";
    const cfg=currencyConfig[currencyCode || currentCurrency] || currencyConfig.INR;
    const currencyName=cfg.name || "units";

    const a=[ "",
    "one",
    "two",
    "three",
    "four",
    "five",
    "six",
    "seven",
    "eight",
    "nine",
    "ten",
    "eleven",
    "twelve",
    "thirteen",
    "fourteen",
    "fifteen",
    "sixteen",
    "seventeen",
    "eighteen",
    "nineteen",
    ];
    const b=[ "",
    "",
    "twenty",
    "thirty",
    "forty",
    "fifty",
    "sixty",
    "seventy",
    "eighty",
    "ninety",
    ];

    function inWords(n) {
        if (n < 20) return a[n];

        if (n < 100) {
            return b[Math.floor(n / 10)] + (n % 10 ? " " + a[n % 10] : "");
        }

        if (n < 1000) {
            return (a[Math.floor(n / 100)] + " hundred" + (n % 100 ? " " + inWords(n % 100) : ""));
        }

        if (n < 100000) {
            return (inWords(Math.floor(n / 1000)) + " thousand" + (n % 1000 ? " " + inWords(n % 1000) : ""));
        }

        if (n < 10000000) {
            return (inWords(Math.floor(n / 100000)) + " lakh" + (n % 100000 ? " " + inWords(n % 100000) : ""));
        }

        if (n < 1000000000) {
            return (inWords(Math.floor(n / 10000000)) + " crore" + (n % 10000000 ? " " + inWords(n % 10000000) : ""));
        }

        return n.toString();
    }

    const words=inWords(num);
    const plural=num===1 ? "" : "";

    return ('<span class="amount-words-tag">In words</span>' + `<span>$ {
            words
        }

        $ {
            currencyName.toLowerCase()
        }

        $ {
            plural
        }

        </span>`);
}

function sipMaturity(monthly, years, annualRate, stepUpPct) {
    const n=Math.max(0, Math.round(years * 12));

    if (n===0 || monthly <=0 || !isFinite(monthly) || !isFinite(years) || !isFinite(annualRate)) {
        return {
            fvPlain: 0, fvStep: 0, totalInvestPlain: 0, totalInvestStep: 0
        }

        ;
    }

    const r=Math.max(0, annualRate) / 12 / 100;
    let fvPlain;

    if (r===0) {
        fvPlain=monthly * n;
    }

    else {
        fvPlain=monthly * ((Math.pow(1 + r, n) - 1) / r);
    }

    let fvStep=0;
    let totalInvestStep=0;
    const stepUpFactor=isFinite(stepUpPct) ? 1 + Math.max(0, stepUpPct) / 100 : 1;
    let currentMonthly=monthly;

    for (let year=0; year < years && isFinite(currentMonthly); year++) {
        const monthsLeft=12 * (years - year);

        if (r===0) {
            fvStep +=currentMonthly * monthsLeft;
        }

        else {
            const yearFV=currentMonthly * ((Math.pow(1 + r, monthsLeft) - 1) / r);

            if (isFinite(yearFV)) {
                fvStep +=yearFV;
            }
        }

        totalInvestStep +=currentMonthly * 12;
        currentMonthly *=stepUpFactor;
        if ( !isFinite(fvStep) || !isFinite(totalInvestStep)) break;
    }

    const totalInvestPlain=monthly * n;

    return {
        fvPlain, fvStep, totalInvestPlain, totalInvestStep
    }

    ;
}

function sipForTarget(target, years, annualRate) {
    const n=Math.max(0, Math.round(years * 12));

    if (n===0 || target <=0 || !isFinite(target) || !isFinite(years) || !isFinite(annualRate)) {
        return 0;
    }

    const r=Math.max(0, annualRate) / 12 / 100;
    if (r===0) return Math.max(0, target / n);
    const factor=(Math.pow(1 + r, n) - 1) / r;
    if (factor===0 || !isFinite(factor)) return 0;
    const result=target / factor;
    return isFinite(result) ? Math.max(0, result) : 0;
}

function durationForTarget(sip, target, annualRate) {
    if (sip <=0 || target <=0 || !isFinite(sip) || !isFinite(target) || !isFinite(annualRate)) {
        return 0;
    }

    const r=Math.max(0, annualRate) / 12 / 100;

    if (r===0) {
        const result=target / sip / 12;
        return isFinite(result) ? Math.max(0, result) : 0;
    }

    const x=1 + (target * r) / sip;
    if (x <=0 || !isFinite(x)) return 0;
    const n=Math.log(x) / Math.log(1 + r);
    const result=n / 12;
    return isFinite(result) ? Math.max(0, result) : 0;
}

function roiForTarget(sip, target, years) {
    if (sip <=0 || target <=0 || years <=0 || !isFinite(sip) || !isFinite(target) || !isFinite(years)) {
        return 0;
    }

    const n=Math.round(years * 12);
    if (n <=0) return 0;
    let low=0;
    let high=0.5;

    for (let i=0; i < 40; i++) {
        const mid=(low + high) / 2;
        const m=mid / 12;
        let fv;

        if (m===0) {
            fv=sip * n;
        }

        else {
            fv=sip * ((Math.pow(1 + m, n) - 1) / m);
        }

        if ( !isFinite(fv)) break;
        if (fv < target) low=mid; else high=mid;
    }

    const result=((low + high) / 2) * 100;
    return isFinite(result) ? Math.max(0, result) : 0;
}

function loanEMI(principal, annualRate, years) {
    const n=years * 12;

    if (principal <=0 || n <=0 || !isFinite(principal) || !isFinite(annualRate) || !isFinite(years)) {
        return {
            emi: 0, totalInterest: 0
        }

        ;
    }

    const r=Math.max(0, annualRate) / 12 / 100;

    if (r===0) {
        const emi=principal / n;

        return {
            emi, totalInterest: 0
        }

        ;
    }

    const emi=(principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
    const totalPaid=emi * n;

    return {
        emi, totalInterest: totalPaid - principal
    }

    ;
}

function swpMaxSafe(corpus, annualReturn, freq) {
    const r=annualReturn / 100;
    const payout=corpus * (r / freq);
    return payout;
}

function swpExhaustWithdrawal(corpus, annualReturn, years, freq) {
    const n=years * freq;
    if (corpus <=0 || n <=0) return 0;
    const r=annualReturn / freq / 100;
    if (r===0) return corpus / n;
    const denom=(Math.pow(1 + r, n) - 1) / r;
    if (denom===0) return 0;
    return corpus / denom;
}

function swpCorpusLife(corpus, withdrawal, annualReturn, freq) {
    if (corpus <=0 || withdrawal <=0 || !isFinite(corpus) || !isFinite(withdrawal) || !isFinite(annualReturn)) {
        return 0;
    }

    const r=Math.max(0, annualReturn) / freq / 100;

    if (r===0) {
        const n=corpus / withdrawal;
        return isFinite(n) ? Math.max(0, n / freq) : 0;
    }

    let n=0;
    let currentCorpus=corpus;
    const maxIterations=100 * freq;

    while (currentCorpus > 0.01 && n < maxIterations) {
        currentCorpus=currentCorpus * (1 + r) - withdrawal;
        n++;
        if ( !isFinite(currentCorpus)) break;
    }

    return isFinite(n) ? Math.max(0, n / freq) : 0;
}

function swpEndCorpus(corpus, withdrawal, years, annualReturn, freq) {
    const n=years * freq;
    const r=annualReturn / freq / 100;
    let bal=corpus;

    for (let i=0; i < n; i++) {
        bal=bal * (1 + r) - withdrawal;

        if (bal < 0) {
            bal=0;
            break;
        }
    }

    return bal;
}

const currencySelect=document.getElementById("currencySelect");
const primaryModeSelect=document.getElementById("primaryModeSelect");
const modeTabs=document.getElementById("modeTabs");
const settingsToggle=document.getElementById("settingsToggle");
const settingsPanel=document.getElementById("settingsPanel");

const panels= {
    left: {
        standard: document.getElementById("leftPanel-standard"),
        "sip-basic": document.getElementById("leftPanel-sip-basic"),
        "sip-target": document.getElementById("leftPanel-sip-target"),
        "sip-duration": document.getElementById("leftPanel-sip-duration"),
        "sip-roi": document.getElementById("leftPanel-sip-roi"),
        swp: document.getElementById("leftPanel-swp"),
        amortization: document.getElementById("leftPanel-amortization"),
        expenses: document.getElementById("leftPanel-expenses"),
    }

    ,
    right: {
        standard: document.getElementById("rightPanel-standard"),
        "sip-basic": document.getElementById("rightPanel-sip-basic"),
        "sip-target": document.getElementById("rightPanel-sip-target"),
        "sip-duration": document.getElementById("rightPanel-sip-duration"),
        "sip-roi": document.getElementById("rightPanel-sip-roi"),
        swp: document.getElementById("rightPanel-swp"),
        amortization: document.getElementById("rightPanel-amortization"),
        expenses: document.getElementById("rightPanel-expenses"),
    }

    ,
}

;

// Expense tracking storage
let expenses=[];

try {
    const stored=window.localStorage.getItem("financeCalcExpenses");

    if (stored) {
        expenses=JSON.parse(stored);
    }
}

catch (e) {
    expenses=[];
}

function saveExpenses() {
    try {
        window.localStorage.setItem("financeCalcExpenses", JSON.stringify(expenses));
    }

    catch (e) {
        console.error("Failed to save expenses:", e);
    }
}

function addExpense() {
    const amount=parseNumber(document.getElementById("expenseAmount").dataset.raw || document.getElementById("expenseAmount").value);
    const category=document.getElementById("expenseCategory").value || "Other";
    const date=document.getElementById("expenseDate").value || new Date().toISOString().split("T")[0];
    const description=document.getElementById("expenseDescription").value || "";

    if (amount <=0) {
        alert("Please enter a valid amount");
        return;
    }

    const expense= {
        id: Date.now(),
        amount,
        category,
        date,
        description,
        timestamp: new Date().toISOString(),
    }

    ;

    expenses.unshift(expense);
    saveExpenses();
    recalcExpenses();

    // Clear form
    document.getElementById("expenseAmount").value="";
    document.getElementById("expenseAmount").dataset.raw="";
    document.getElementById("expenseDescription").value="";
    document.getElementById("expenseDate").value=new Date().toISOString().split("T")[0];
}

function deleteExpense(id) {
    expenses=expenses.filter((e)=> e.id !==id);
    saveExpenses();
    recalcExpenses();
}

function recalcExpenses() {
    if (expenses.length===0) {
        document.getElementById("expenseTotalDisplay").textContent=formatNumber(0, currentCurrency);
        document.getElementById("expenseMonthDisplay").textContent=formatNumber(0, currentCurrency);
        document.getElementById("expenseDailyAvgDisplay").textContent=formatNumber(0, currentCurrency);
        document.getElementById("expenseCountDisplay").textContent="0";
        document.getElementById("expenseCategoryBreakdown").innerHTML='<div class="empty-state">No expenses added yet</div>';
        document.getElementById("expenseList").innerHTML='<div class="empty-state">No expenses added yet</div>';
        return;
    }

    const total=expenses.reduce((sum, e)=> sum + e.amount, 0);
    const now=new Date();
    const currentMonth=expenses.filter((e)=> new Date(e.date).getMonth()===now.getMonth() && new Date(e.date).getFullYear()===now.getFullYear());
    const monthTotal=currentMonth.reduce((sum, e)=> sum + e.amount, 0);

    const dates=expenses.map((e)=> new Date(e.date));
    const minDate=new Date(Math.min(...dates));
    const maxDate=new Date(Math.max(...dates));
    const daysDiff=Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1);
    const dailyAvg=total / daysDiff;

    document.getElementById("expenseTotalDisplay").textContent=formatNumber(total, currentCurrency);
    document.getElementById("expenseMonthDisplay").textContent=formatNumber(monthTotal, currentCurrency);
    document.getElementById("expenseDailyAvgDisplay").textContent=formatNumber(dailyAvg, currentCurrency);
    document.getElementById("expenseCountDisplay").textContent=expenses.length.toString();

    // Category breakdown
    const categoryTotals= {}

    ;

    expenses.forEach((e)=> {
            categoryTotals[e.category]=(categoryTotals[e.category] || 0) + e.amount;
        });

    const sortedCategories=Object.entries(categoryTotals) .sort((a, b)=> b[1] - a[1]) .slice(0, 8);

    const maxCategory=Math.max(...sortedCategories.map((c)=> c[1]), 1);

    let breakdownHTML="";

    sortedCategories.forEach(([category, amount])=> {
            const percentage=(amount / total) * 100;
            const width=(amount / maxCategory) * 100;

            breakdownHTML +=` <div class="category-bar" > <div class="category-bar-label" >$ {
                category
            }

            </div> <div class="category-bar-fill" > <div class="category-bar-value" style="width: ${width}%" ></div> </div> <div class="category-bar-amount" >$ {
                formatNumber(amount, currentCurrency, false)
            }

            ($ {
                    percentage.toFixed(1)
                }

                %)</div> </div> `;
        });

    document.getElementById("expenseCategoryBreakdown").innerHTML=breakdownHTML || '<div class="empty-state">No expenses added yet</div>';

    // Expense list (show last 20)
    const recentExpenses=expenses.slice(0, 20);
    let listHTML="";

    recentExpenses.forEach((expense)=> {
            const dateObj=new Date(expense.date);

            const dateStr=dateObj.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: dateObj.getFullYear() !==now.getFullYear() ? "numeric" : undefined,
            });

        listHTML +=` <div class="expense-item" > <div class="expense-item-left" > <div class="expense-item-category" >$ {
            expense.category
        }

        </div> <div class="expense-item-date" >$ {
            dateStr
        }

        $ {
            expense.description ? " ‚Ä¢ " + expense.description : ""
        }

        </div> </div> <div class="expense-item-amount" >$ {
            formatNumber(expense.amount, currentCurrency, false)
        }

        </div> <div class="expense-item-actions" > <button onclick="deleteExpense(${expense.id})" >Delete</button> </div> </div> `;
    });

document.getElementById("expenseList").innerHTML=listHTML || '<div class="empty-state">No expenses added yet</div>';
}

// Make deleteExpense available globally for onclick handlers
window.deleteExpense=deleteExpense;

function setMode(mode) {
    Object.keys(panels.left).forEach((key)=> {
            if (panels.left[key]) {
                panels.left[key].classList.toggle("hidden", key !==mode);
            }
        });

    Object.keys(panels.right).forEach((key)=> {
            if (panels.right[key]) {
                panels.right[key].classList.toggle("hidden", key !==mode);
            }
        });

    document.querySelectorAll(".mode-tab").forEach((btn)=> {
            btn.classList.toggle("active", btn.dataset.mode===mode);
        });
    primaryModeSelect.value=mode;
    debouncedRecalc();
}

modeTabs.addEventListener("click", (e)=> {
        const btn=e.target.closest(".mode-tab");
        if ( !btn) return;
        const mode=btn.dataset.mode;
        if (mode) setMode(mode);
    });

primaryModeSelect.addEventListener("change", (e)=> {
        setMode(e.target.value);
    });

currencySelect.addEventListener("change", ()=> {
        currentCurrency=currencySelect.value || "INR";

        document.querySelectorAll(".currency-prefix").forEach((el)=> {
                el.textContent=currencyConfig[currentCurrency].symbol;
            });
        debouncedRecalc();
    });

if (settingsToggle && settingsPanel) {
    settingsToggle.addEventListener("click", ()=> {
            settingsPanel.classList.toggle("hidden");
        });
}

const themeToggle=document.getElementById("themeToggle");

if (themeToggle) {
    themeToggle.addEventListener("click", (e)=> {
            const btn=e.target.closest("button");
            if ( !btn) return;
            const theme=btn.dataset.theme || "dark";
            applyTheme(theme);
        });
}

const viewModeToggle=document.getElementById("viewModeToggle");

if (viewModeToggle) {
    viewModeToggle.addEventListener("click", (e)=> {
            const btn=e.target.closest("button");
            if ( !btn) return;
            const mode=btn.dataset.view || "advanced";
            applyViewMode(mode);
        });
}

document.querySelectorAll(".field-group").forEach((fg)=> {
        const input=fg.querySelector("input, select, textarea");
        if ( !input) return;
        input.addEventListener("focus", ()=> fg.classList.add("focused"));

        input.addEventListener("blur", ()=> {
                fg.classList.remove("focused");
                // Validate on blur
                const value=parseNumber(input.dataset.raw || input.value);
                const allowsDecimals=input.getAttribute("inputmode")==="decimal";
                const max=allowsDecimals ? 100 : Infinity;
                const validation=validateInput(value, 0, max, "");

                if ( !validation.valid && value > 0) {
                    fg.classList.add("invalid");
                }

                else {
                    fg.classList.remove("invalid");
                }
            });

        // Add keyboard navigation
        input.addEventListener("keydown", (e)=> {
                if (e.key==="Enter") {
                    input.blur();
                }
            });
    });

const amountWordsMap= {
    housePrice: "housePriceWords",
    middleDown: "middleDownWords",
    investorDown: "investorDownWords",
    sipAmount: "sipAmountWords",
    targetCorpus: "targetCorpusWords",
    durSipAmount: "durSipAmountWords",
    durTargetCorpus: "durTargetCorpusWords",
    roiSipAmount: "roiSipAmountWords",
    roiTargetCorpus: "roiTargetCorpusWords",
    swpCorpus: "swpCorpusWords",
    swpWithdrawal: "swpWithdrawalWords",
    swpReqWithdrawal: "swpReqWithdrawalWords",
    amortPrincipal: "amortPrincipalWords",
}

;

// Debounced recalculation function with error handling
const debouncedRecalc=debounce(()=> {
        try {
            recalcAll();
        }

        catch (error) {
            console.error("Calculation error:", error);
            // Gracefully handle errors - don't break the UI
        }
    }

    , 300);

Object.entries(amountWordsMap).forEach(([inputId, wordsId])=> {
        const input=document.getElementById(inputId);
        const wordsDiv=document.getElementById(wordsId);
        if ( !input || !wordsDiv) return;

        input.addEventListener("input", ()=> {
                formatInputWithCommas(input);
                const raw=parseNumber(input.dataset.raw || input.value);

                if (raw > 0) {
                    wordsDiv.innerHTML=numberToWords(raw, currentCurrency);
                }

                else {
                    wordsDiv.innerHTML="";
                }

                debouncedRecalc();
            });
    });

// Expense amount input formatting
const expenseAmountInput=document.getElementById("expenseAmount");

if (expenseAmountInput) {
    expenseAmountInput.addEventListener("input", ()=> {
            formatInputWithCommas(expenseAmountInput);
        });

    expenseAmountInput.addEventListener("keydown", (e)=> {
            if (e.key==="Enter") {
                addExpense();
            }
        });
}

document.querySelectorAll("#years,#middleRate,#investorRate,#houseGrowth,#equityReturn,#sipYears,#sipReturn,#sipStepUp,#targetYears,#targetReturn,#targetStepUp,#durReturn,#durStepUp,#roiYears,#roiStepUp,#swpDuration,#swpReturn,#swpReqDuration,#swpReqReturn,#amortRate,#amortYears"

).forEach((input)=> {
        input.addEventListener("input", ()=> {
                formatInputWithCommas(input);
                debouncedRecalc();
            });
    });

document.querySelectorAll("#enableStepUpStandard,#stepUpPercentStandard,#enableStepUpBasic,#enableStepUpTarget,#enableStepUpDur,#enableStepUpRoi"

).forEach((el)=> {
        el.addEventListener(el.tagName==="INPUT" && el.type==="checkbox" ? "change" : "input",
            debouncedRecalc);
    });

const swpFrequency=document.getElementById("swpFrequency");
swpFrequency.addEventListener("change", debouncedRecalc);

const amortFreqToggle=document.getElementById("amortFreqToggle");

if (amortFreqToggle) {
    amortFreqToggle.addEventListener("click", (e)=> {
            const btn=e.target.closest("button");
            if ( !btn) return;
            amortFreqToggle .querySelectorAll("button") .forEach((b)=> b.classList.toggle("active", b===btn));
            debouncedRecalc();
        });
}

const addExpenseBtn=document.getElementById("addExpenseBtn");

if (addExpenseBtn) {
    addExpenseBtn.addEventListener("click", ()=> {
            addExpense();
        });
}

// Set default date to today
const expenseDateInput=document.getElementById("expenseDate");

if (expenseDateInput && !expenseDateInput.value) {
    expenseDateInput.value=new Date().toISOString().split("T")[0];
}

const swpModeToggle=document.getElementById("swpModeToggle");
const swpFromCorpusInputs=document.getElementById("swpFromCorpusInputs");
const swpRequiredCorpusInputs=document.getElementById("swpRequiredCorpusInputs"
);

swpModeToggle.addEventListener("click", (e)=> {
        const btn=e.target.closest("button");
        if ( !btn) return;
        const mode=btn.dataset.swpMode;
        swpModeToggle .querySelectorAll("button") .forEach((b)=> b.classList.toggle("active", b===btn));

        if (mode==="fromCorpus") {
            swpFromCorpusInputs.classList.remove("hidden");
            swpRequiredCorpusInputs.classList.add("hidden");
        }

        else {
            swpFromCorpusInputs.classList.add("hidden");
            swpRequiredCorpusInputs.classList.remove("hidden");
        }

        debouncedRecalc();
    });

function recalcStandard() {
    const housePrice=Math.max(0, parseNumber(document.getElementById("housePrice").dataset.raw || document.getElementById("housePrice").value));
    const years=Math.max(0, Math.min(100, parseNumber(document.getElementById("years").dataset.raw || document.getElementById("years").value)));
    const middleDown=parseNumber(document.getElementById("middleDown").dataset.raw || document.getElementById("middleDown").value);
    const investorDown=parseNumber(document.getElementById("investorDown").dataset.raw || document.getElementById("investorDown").value);
    const middleRate=parseNumber(document.getElementById("middleRate").dataset.raw || document.getElementById("middleRate").value);
    const investorRate=parseNumber(document.getElementById("investorRate").dataset.raw || document.getElementById("investorRate").value);
    const houseGrowth=parseNumber(document.getElementById("houseGrowth").dataset.raw || document.getElementById("houseGrowth").value);
    const equityReturn=parseNumber(document.getElementById("equityReturn").dataset.raw || document.getElementById("equityReturn").value);
    const enableStepUpStandard=document.getElementById("enableStepUpStandard").checked;
    const stepUpPercentStandard=parseNumber(document.getElementById("stepUpPercentStandard").dataset.raw || document.getElementById("stepUpPercentStandard").value);

    const middleLoan=Math.max(0, housePrice - middleDown);
    const investorLoan=Math.max(0, housePrice - investorDown);

    const middleLoanRes=loanEMI(middleLoan, middleRate, years);
    const investorLoanRes=loanEMI(investorLoan, investorRate, years);

    const middleEmi=middleLoanRes.emi;
    const middleInterest=middleLoanRes.totalInterest;
    const investorEmi=investorLoanRes.emi;
    const investorInterest=investorLoanRes.totalInterest;

    const houseFutureValue=housePrice > 0 && years > 0 && isFinite(houseGrowth) ? housePrice * Math.pow(1 + Math.max(0, houseGrowth) / 100, years) : 0;
    const middleHouseGain=houseFutureValue - housePrice - middleInterest;
    const investorHouseGain=houseFutureValue - housePrice - investorInterest;

    const middleRoi=middleDown > 0 ? (middleHouseGain / middleDown) * 100 : 0;
    const investorRoi=investorDown > 0 ? (investorHouseGain / investorDown) * 100 : 0;

    const extraCapitalInvestor=Math.max(0, middleDown - investorDown);
    const investorEquityFuture=extraCapitalInvestor * Math.pow(1 + equityReturn / 100, years);

    const emiDiff=Math.max(0, investorEmi - middleEmi);
    let emiSipFuture=0;

    if (emiDiff > 0) {
        if (enableStepUpStandard) {
            const stepRes=sipMaturity(emiDiff,
                years,
                equityReturn,
                stepUpPercentStandard);
            emiSipFuture=stepRes.fvStep;
        }

        else {
            const plainRes=sipMaturity(emiDiff, years, equityReturn, 0);
            emiSipFuture=plainRes.fvPlain;
        }
    }

    const middleTotalWealth=houseFutureValue + emiSipFuture;
    const investorTotalWealth=houseFutureValue + investorEquityFuture;

    document.getElementById("middleEmiDisplay").textContent=formatNumber(middleEmi,
        currentCurrency);
    document.getElementById("middleInterestDisplay").textContent=formatNumber(middleInterest, currentCurrency);
    document.getElementById("investorEmiDisplay").textContent=formatNumber(investorEmi, currentCurrency);
    document.getElementById("investorInterestDisplay").textContent=formatNumber(investorInterest, currentCurrency);
    document.getElementById("houseFutureValueDisplay").textContent=formatNumber(houseFutureValue, currentCurrency);
    document.getElementById("houseCagrDisplay").textContent=houseGrowth.toFixed(1) + "%";
    document.getElementById("middleHouseGainDisplay").textContent=formatNumber(middleHouseGain, currentCurrency);
    document.getElementById("investorHouseGainDisplay").textContent=formatNumber(investorHouseGain, currentCurrency);
    document.getElementById("middleRoiDisplay").textContent=middleRoi.toFixed(1) + "%";
    document.getElementById("investorRoiDisplay").textContent=investorRoi.toFixed(1) + "%";
    document.getElementById("investorEquityFutureDisplay").textContent=formatNumber(investorEquityFuture, currentCurrency);
    document.getElementById("emiSipFutureDisplay").textContent=formatNumber(emiSipFuture, currentCurrency);
    document.getElementById("middleTotalWealthDisplay").textContent=formatNumber(middleTotalWealth, currentCurrency);
    document.getElementById("investorTotalWealthDisplay").textContent=formatNumber(investorTotalWealth, currentCurrency);
}

function recalcSipBasic() {
    const sipAmount=parseNumber(document.getElementById("sipAmount").dataset.raw || document.getElementById("sipAmount").value);
    const years=parseNumber(document.getElementById("sipYears").dataset.raw || document.getElementById("sipYears").value);
    const annualReturn=parseNumber(document.getElementById("sipReturn").dataset.raw || document.getElementById("sipReturn").value);
    const stepUp=parseNumber(document.getElementById("sipStepUp").dataset.raw || document.getElementById("sipStepUp").value);
    const enableStepUpBasic=document.getElementById("enableStepUpBasic").checked;

    const resPlain=sipMaturity(sipAmount, years, annualReturn, 0);
    const resStep=sipMaturity(sipAmount,
        years,
        annualReturn,
        enableStepUpBasic ? stepUp : 0);

    const months=Math.max(0, Math.round(years * 12));

    const totalInvestedPlain=resPlain.totalInvestPlain;
    const totalInvestedStep=resStep.totalInvestStep;
    const fvPlain=resPlain.fvPlain;
    const fvStep=resStep.fvStep;

    const maturity=enableStepUpBasic ? fvStep : fvPlain;
    const totalInvested=enableStepUpBasic ? totalInvestedStep : totalInvestedPlain;
    const gain=maturity - totalInvested;
    const cagr=annualReturn;

    const avgMonthly=totalInvested / Math.max(1, months);
    const wealthMultiple=totalInvested > 0 ? maturity / totalInvested : 0;

    const delayYears=5;
    const delayRes=sipMaturity(sipAmount, years - delayYears, annualReturn, 0);
    const delayLoss=fvPlain - delayRes.fvPlain;

    document.getElementById("sipTotalInvestedDisplay").textContent=formatNumber(totalInvested, currentCurrency);
    document.getElementById("sipMonthsDisplay").textContent=months.toString();
    document.getElementById("sipMaturityDisplay").textContent=formatNumber(maturity, currentCurrency);
    document.getElementById("sipGainDisplay").textContent=formatNumber(gain, currentCurrency);
    document.getElementById("sipCagrDisplay").textContent=cagr.toFixed(1) + "%";

    document.getElementById("sipPlainMaturityDisplay").textContent=formatNumber(fvPlain, currentCurrency);
    document.getElementById("sipStepMaturityDisplay").textContent=formatNumber(fvStep, currentCurrency);
    document.getElementById("sipExtraStepDisplay").textContent=formatNumber(fvStep - fvPlain,
        currentCurrency);
    document.getElementById("sipAvgMonthlyDisplay").textContent=formatNumber(avgMonthly, currentCurrency);
    document.getElementById("sipWealthMultipleDisplay").textContent=wealthMultiple.toFixed(1) + "x";
    document.getElementById("sipDelayCostDisplay").textContent=formatNumber(delayLoss, currentCurrency);

    // Calculate and display SIP breakdown - Without Step-up
    const breakdownPlain=calculateSipBreakdown(sipAmount, years, annualReturn, 0, false);
    const breakdownBodyPlain=document.getElementById("sipBreakdownBodyPlain");

    if (breakdownBodyPlain) {
        breakdownBodyPlain.innerHTML="";

        breakdownPlain.forEach((entry)=> {
                const row=document.createElement("tr");

                row.innerHTML=` <td>$ {
                    entry.year
                }

                </td> <td>$ {
                    entry.month
                }

                </td> <td>$ {
                    formatNumber(entry.investment, currentCurrency, false)
                }

                </td> <td>$ {
                    formatNumber(entry.value, currentCurrency, false)
                }

                </td> `;
                breakdownBodyPlain.appendChild(row);
            });
    }

    // Calculate and display SIP breakdown - With Step-up
    const breakdownStep=calculateSipBreakdown(sipAmount, years, annualReturn, stepUp, true);
    const breakdownBodyStep=document.getElementById("sipBreakdownBodyStep");

    if (breakdownBodyStep) {
        breakdownBodyStep.innerHTML="";

        breakdownStep.forEach((entry)=> {
                const row=document.createElement("tr");

                row.innerHTML=` <td>$ {
                    entry.year
                }

                </td> <td>$ {
                    entry.month
                }

                </td> <td>$ {
                    formatNumber(entry.investment, currentCurrency, false)
                }

                </td> <td>$ {
                    formatNumber(entry.value, currentCurrency, false)
                }

                </td> `;
                breakdownBodyStep.appendChild(row);
            });
    }
}

function recalcSipTarget() {
    const targetCorpus=parseNumber(document.getElementById("targetCorpus").dataset.raw || document.getElementById("targetCorpus").value);
    const years=parseNumber(document.getElementById("targetYears").dataset.raw || document.getElementById("targetYears").value);
    const annualReturn=parseNumber(document.getElementById("targetReturn").dataset.raw || document.getElementById("targetReturn").value);
    const stepUp=parseNumber(document.getElementById("targetStepUp").dataset.raw || document.getElementById("targetStepUp").value);
    const enableStepUpTarget=document.getElementById("enableStepUpTarget").checked;

    let requiredSip=0;
    let totalInvest=0;
    const months=Math.max(0, Math.round(years * 12));

    if ( !enableStepUpTarget) {
        requiredSip=sipForTarget(targetCorpus, years, annualReturn);
        totalInvest=requiredSip * months;
    }

    else {
        let guess=targetCorpus / (months * 0.6 || 1);
        let low=0;
        let high=guess * 5;

        for (let i=0; i < 40; i++) {
            const mid=(low + high) / 2;
            const res=sipMaturity(mid, years, annualReturn, stepUp);
            const fv=res.fvStep;
            if (fv < targetCorpus) low=mid;
            else high=mid;
        }

        requiredSip=(low + high) / 2;
        const resFinal=sipMaturity(requiredSip, years, annualReturn, stepUp);
        totalInvest=resFinal.totalInvestStep;
    }

    const wealthMultiple=totalInvest > 0 ? targetCorpus / totalInvest : 0;

    document.getElementById("reqSipDisplay").textContent=formatNumber(requiredSip, currentCurrency);
    document.getElementById("reqTotalInvestDisplay").textContent=formatNumber(totalInvest, currentCurrency);
    document.getElementById("reqMonthsDisplay").textContent=months.toString();
    document.getElementById("reqWealthMultipleDisplay").textContent=wealthMultiple.toFixed(1) + "x";

    document.getElementById("reqSipIncomePctDisplay").textContent="‚Äì";
    document.getElementById("reqRealisticFlag").textContent=wealthMultiple > 2.5 ? "Market‚Äëdependent" : "More savings‚Äëdriven";

    document.getElementById("reqFutureIfReducedDisplay").textContent=formatNumber(targetCorpus * 0.8, currentCurrency);
    const sipIfExtra5=sipForTarget(targetCorpus, years + 5, annualReturn);
    document.getElementById("reqSipIfExtra5YrDisplay").textContent=formatNumber(sipIfExtra5, currentCurrency);
    const sipIfLowerReturn=sipForTarget(targetCorpus, years, Math.max(0, annualReturn - 2));
    document.getElementById("reqSipIfLowerReturnDisplay").textContent=formatNumber(sipIfLowerReturn, currentCurrency);
}

function recalcSipDuration() {
    const sipAmount=parseNumber(document.getElementById("durSipAmount").dataset.raw || document.getElementById("durSipAmount").value);
    const targetCorpus=parseNumber(document.getElementById("durTargetCorpus").dataset.raw || document.getElementById("durTargetCorpus").value);
    const annualReturn=parseNumber(document.getElementById("durReturn").dataset.raw || document.getElementById("durReturn").value);
    const stepUp=parseNumber(document.getElementById("durStepUp").dataset.raw || document.getElementById("durStepUp").value);
    const enableStepUpDur=document.getElementById("enableStepUpDur").checked;

    let years=0;

    if ( !enableStepUpDur) {
        years=durationForTarget(sipAmount, targetCorpus, annualReturn);
    }

    else {
        let low=0;
        let high=60;

        for (let i=0; i < 40; i++) {
            const mid=(low + high) / 2;
            const res=sipMaturity(sipAmount,
                mid,
                annualReturn,
                stepUp);
            const fv=res.fvStep;
            if (fv < targetCorpus) low=mid;
            else high=mid;
        }

        years=(low + high) / 2;
    }

    const months=Math.round(years * 12);
    const totalInvest=sipAmount * months;
    const wealthMultiple=totalInvest > 0 ? targetCorpus / totalInvest : 0;

    document.getElementById("durYearsDisplay").textContent=years.toFixed(1) + " yrs";
    document.getElementById("durMonthsDisplay").textContent=months.toString();
    document.getElementById("durTotalInvestedDisplay").textContent=formatNumber(totalInvest, currentCurrency);
    document.getElementById("durWealthMultipleDisplay").textContent=wealthMultiple.toFixed(1) + "x";

    document.getElementById("durYearsIfHigherSipDisplay").textContent=Math.max(0, years * 0.85).toFixed(1) + " yrs";
    document.getElementById("durYearsIfHigherReturnDisplay").textContent=Math.max(0, years * 0.9).toFixed(1) + " yrs";
    document.getElementById("durYearsIfLowerReturnDisplay").textContent=(years * 1.1).toFixed(1) + " yrs";

    const delayRes=sipMaturity(sipAmount, years - 3, annualReturn, 0);
    const fullRes=sipMaturity(sipAmount, years, annualReturn, 0);
    const delayLoss=fullRes.fvPlain - delayRes.fvPlain;
    document.getElementById("durLossIfDelayDisplay").textContent=formatNumber(delayLoss, currentCurrency);
    document.getElementById("durAgeFlagDisplay").textContent="Align with retirement / child education age";
}

function recalcSipRoi() {
    const sipAmount=parseNumber(document.getElementById("roiSipAmount").dataset.raw || document.getElementById("roiSipAmount").value);
    const targetCorpus=parseNumber(document.getElementById("roiTargetCorpus").dataset.raw || document.getElementById("roiTargetCorpus").value);
    const years=parseNumber(document.getElementById("roiYears").dataset.raw || document.getElementById("roiYears").value);
    const stepUp=parseNumber(document.getElementById("roiStepUp").dataset.raw || document.getElementById("roiStepUp").value);
    const enableStepUpRoi=document.getElementById("enableStepUpRoi").checked;

    let requiredRoi=0;

    if ( !enableStepUpRoi) {
        requiredRoi=roiForTarget(sipAmount, targetCorpus, years);
    }

    else {
        let low=0;
        let high=0.5;

        for (let i=0; i < 40; i++) {
            const mid=(low + high) / 2;
            const res=sipMaturity(sipAmount,
                years,
                mid * 100,
                stepUp);
            const fv=res.fvStep;
            if (fv < targetCorpus) low=mid;
            else high=mid;
        }

        requiredRoi=((low + high) / 2) * 100;
    }

    document.getElementById("roiRequiredDisplay").textContent=requiredRoi.toFixed(1) + "%";
    let riskFlag="Moderate";
    if (requiredRoi <=10) riskFlag="Comfortable";
    else if (requiredRoi <=14) riskFlag="Reasonable";
    else if (requiredRoi <=18) riskFlag="Stretch";
    else riskFlag="Aggressive";
    document.getElementById("roiRiskFlagDisplay").textContent=riskFlag;

    document.getElementById("roiIfHigherSipDisplay").textContent=Math.max(0, requiredRoi * 0.85).toFixed(1) + "%";
    document.getElementById("roiIfLongerTenorDisplay").textContent=Math.max(0, requiredRoi * 0.9).toFixed(1) + "%";
    document.getElementById("roiIfLowerGoalDisplay").textContent=Math.max(0, requiredRoi * 0.8).toFixed(1) + "%";
}

function recalcSwp() {
    const freq=parseInt(swpFrequency.value || "12", 10);

    const swpMode= !swpFromCorpusInputs.classList.contains("hidden") ? "fromCorpus"
    : "requiredCorpus";

    let corpus=parseNumber(document.getElementById("swpCorpus").dataset.raw || document.getElementById("swpCorpus").value);
    let durationYears=parseNumber(document.getElementById("swpDuration").dataset.raw || document.getElementById("swpDuration").value);
    let annualReturn=parseNumber(document.getElementById("swpReturn").dataset.raw || document.getElementById("swpReturn").value);
    let withdrawal=parseNumber(document.getElementById("swpWithdrawal").dataset.raw || document.getElementById("swpWithdrawal").value);

    if (swpMode==="requiredCorpus") {
        const reqWithdrawal=parseNumber(document.getElementById("swpReqWithdrawal").dataset.raw || document.getElementById("swpReqWithdrawal").value);
        const reqDurationYears=parseNumber(document.getElementById("swpReqDuration").dataset.raw || document.getElementById("swpReqDuration").value);
        const reqReturn=parseNumber(document.getElementById("swpReqReturn").dataset.raw || document.getElementById("swpReqReturn").value);

        if (reqWithdrawal > 0 && reqReturn > 0) {
            const safeCorpus=reqWithdrawal / (reqReturn / 100 / freq);
            const exhaustCorpus=reqDurationYears > 0 ? reqWithdrawal / ((reqReturn / 100 / freq) * (Math.pow(1 + reqReturn / 100 / freq,
                        reqDurationYears * freq) - 1)) : 0;

            corpus=safeCorpus;
            durationYears=reqDurationYears;
            annualReturn=reqReturn;
            withdrawal=reqWithdrawal;

            document.getElementById("swpReqCorpusDisplay").textContent=formatNumber(exhaustCorpus, currentCurrency);
        }
    }

    const maxSafeWithdrawal=swpMaxSafe(corpus,
        annualReturn,
        freq);
    const exhaustWithdrawal=swpExhaustWithdrawal(corpus,
        annualReturn,
        durationYears,
        freq);
    const corpusLifeYears=swpCorpusLife(corpus,
        withdrawal,
        annualReturn,
        freq);
    const endCorpus=swpEndCorpus(corpus,
        withdrawal,
        durationYears,
        annualReturn,
        freq);

    let sustainabilityFlag="‚Äì";

    if (withdrawal <=0 || corpus <=0) {
        sustainabilityFlag="Enter corpus & withdrawal";
    }

    else if (withdrawal <=maxSafeWithdrawal * 1.02) {
        sustainabilityFlag="Safe (principal intact)";
    }

    else if (withdrawal <=exhaustWithdrawal * 1.02) {
        sustainabilityFlag="Will deplete around plan end";
    }

    else if (corpusLifeYears >=durationYears) {
        sustainabilityFlag="Slightly aggressive but lasts";
    }

    else {
        sustainabilityFlag="Unsustainable (corpus ends in ~" + corpusLifeYears.toFixed(1) + " yrs)";
    }

    const fdMonthly=corpus * (annualReturn / 100 / 12);
    const fdQuarterly=corpus * (annualReturn / 100 / 4);
    const fdHalfYearly=corpus * (annualReturn / 100 / 2);
    const fdYearly=corpus * (annualReturn / 100);

    const totalWithdrawals=withdrawal * (durationYears * freq);

    document.getElementById("swpMaxSafeDisplay").textContent=formatNumber(maxSafeWithdrawal, currentCurrency);
    document.getElementById("swpExhaustWithdrawalDisplay"
    ).textContent=formatNumber(exhaustWithdrawal,
        currentCurrency);
    document.getElementById("swpCorpusLifeDisplay").textContent=corpusLifeYears.toFixed(1) + " yrs";
    document.getElementById("swpSustainabilityFlag").textContent=sustainabilityFlag;

    document.getElementById("fdMonthlyDisplay").textContent=formatNumber(fdMonthly, currentCurrency);
    document.getElementById("fdQuarterlyDisplay").textContent=formatNumber(fdQuarterly, currentCurrency);
    document.getElementById("fdHalfYearlyDisplay").textContent=formatNumber(fdHalfYearly, currentCurrency);
    document.getElementById("fdYearlyDisplay").textContent=formatNumber(fdYearly, currentCurrency);

    document.getElementById("swpTotalWithdrawalsDisplay").textContent=formatNumber(totalWithdrawals, currentCurrency);
    document.getElementById("swpEndCorpusDisplay").textContent=formatNumber(endCorpus, currentCurrency);

    if (swpMode==="fromCorpus") {
        document.getElementById("swpReqCorpusDisplay").textContent=formatNumber(withdrawal / (annualReturn / 100 / freq || 1),
            currentCurrency);
    }
}

function calculateAmortizationSchedule(principal, annualRate, years) {
    const schedule=[];
    const n=years * 12;

    if (principal <=0 || n <=0 || !isFinite(principal) || !isFinite(annualRate) || !isFinite(years)) {
        return schedule;
    }

    const r=Math.max(0, annualRate) / 12 / 100;
    let balance=principal;

    if (r===0) {
        const emi=principal / n;

        for (let month=1; month <=n; month++) {
            const principalPaid=emi;
            balance -=principalPaid;

            schedule.push({
                month,
                emi,
                principal: principalPaid,
                interest: 0,
                balance: Math.max(0, balance)
            });
    }
}

else {
    const emi=(principal * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);

    for (let month=1; month <=n; month++) {
        const interest=balance * r;
        const principalPaid=emi - interest;
        balance -=principalPaid;

        schedule.push({
            month,
            emi,
            principal: principalPaid,
            interest,
            balance: Math.max(0, balance)
        });
}
}

return schedule;
}

function calculateSipBreakdown(monthly, years, annualRate, stepUpPct, enableStepUp) {
    const breakdown=[];
    const n=Math.max(0, Math.round(years * 12));

    if (n===0 || monthly <=0 || !isFinite(monthly) || !isFinite(years) || !isFinite(annualRate)) {
        return breakdown;
    }

    const r=Math.max(0, annualRate) / 12 / 100;
    const stepUpFactor=enableStepUp && isFinite(stepUpPct) ? 1 + Math.max(0, stepUpPct) / 100 : 1;
    let currentMonthly=monthly;
    let totalValue=0;
    let totalInvested=0;

    for (let month=1; month <=n; month++) {
        totalInvested +=currentMonthly;

        if (r===0) {
            totalValue +=currentMonthly;
        }

        else {
            totalValue=totalValue * (1 + r) + currentMonthly;
        }

        // Add entry at year end or every 12 months
        if (month % 12===0 || month===n) {
            breakdown.push({
                year: Math.ceil(month / 12),
                month: month,
                investment: totalInvested,
                value: totalValue,
                gain: totalValue - totalInvested
            });
    }

    // Step up at year end
    if (month % 12===0 && enableStepUp) {
        currentMonthly *=stepUpFactor;
    }
}

return breakdown;
}

function recalcAmortization() {
    const principal=parseNumber(document.getElementById("amortPrincipal").dataset.raw || document.getElementById("amortPrincipal").value);
    const annualRate=parseNumber(document.getElementById("amortRate").dataset.raw || document.getElementById("amortRate").value);
    const years=parseNumber(document.getElementById("amortYears").dataset.raw || document.getElementById("amortYears").value);

    const typeEl=document.getElementById("amortType");
    const amortType=typeEl ? typeEl.value || "reducing" : "reducing";
    const freqToggle=document.getElementById("amortFreqToggle");
    const freqBtnActive=freqToggle && freqToggle.querySelector("button.active");
    const scheduleMode=(freqBtnActive && freqBtnActive.dataset.amortFreq) || "monthly";

    let schedule=[];

    if (amortType==="flat") {
        // Flat / simple interest
        const n=years * 12;

        if (principal > 0 && annualRate >=0 && n > 0) {
            const totalInterest=principal * (annualRate / 100) * years;
            const totalPayment=principal + totalInterest;
            const emi=totalPayment / n;
            let balance=principal;

            for (let month=1; month <=n; month++) {
                const interest=totalInterest / n;
                const principalPaid=emi - interest;
                balance -=principalPaid;

                schedule.push({
                    month,
                    emi,
                    principal: principalPaid,
                    interest,
                    balance: Math.max(0, balance),
                });
        }
    }
}

else if (amortType==="interest-only") {
    const n=years * 12;

    if (principal > 0 && annualRate >=0 && n > 0) {
        const r=Math.max(0, annualRate) / 12 / 100;
        const interestEmi=principal * r;
        let balance=principal;

        for (let month=1; month <=n; month++) {
            let emi=interestEmi;
            let principalPaid=0;
            const interest=interestEmi;

            if (month===n) {
                emi +=principal;
                principalPaid=principal;
                balance=0;
            }

            schedule.push({
                month,
                emi,
                principal: principalPaid,
                interest,
                balance: Math.max(0, balance),
            });
    }
}
}

else {
    // Reducing (EMI)
    schedule=calculateAmortizationSchedule(principal, annualRate, years);
}

const tbody=document.getElementById("amortizationBody");
if ( !tbody) return;

tbody.innerHTML="";

if (schedule.length===0) {
    return;
}

const totalMonths=schedule.length;
const totalPayment=schedule[0].emi * totalMonths;
const totalInterest=totalPayment - principal;

document.getElementById("amortEmiDisplay").textContent=formatNumber(schedule[0].emi, currentCurrency);
document.getElementById("amortTotalInterestDisplay").textContent=formatNumber(totalInterest, currentCurrency);
document.getElementById("amortTotalPaymentDisplay").textContent=formatNumber(totalPayment, currentCurrency);
document.getElementById("amortTotalMonthsDisplay").textContent=totalMonths.toString();

const periodHeader=document.getElementById("amortPeriodHeader");

if (periodHeader) {
    periodHeader.textContent=scheduleMode==="yearly" ? "Year" : "Month";
}

if (scheduleMode==="yearly") {
    // Aggregate schedule by year
    const yearly=[];

    schedule.forEach((entry)=> {
            const year=Math.ceil(entry.month / 12);

            if ( !yearly[year]) {
                yearly[year]= {
                    period: year,
                    emi: 0,
                    principal: 0,
                    interest: 0,
                    balance: entry.balance,
                }

                ;
            }

            yearly[year].emi +=entry.emi;
            yearly[year].principal +=entry.principal;
            yearly[year].interest +=entry.interest;
            yearly[year].balance=entry.balance;
        });

    yearly.forEach((y)=> {
            if ( !y) return;
            const row=document.createElement("tr");

            row.innerHTML=` <td>$ {
                y.period
            }

            </td> <td>$ {
                formatNumber(y.emi, currentCurrency, false)
            }

            </td> <td>$ {
                formatNumber(y.principal, currentCurrency, false)
            }

            </td> <td>$ {
                formatNumber(y.interest, currentCurrency, false)
            }

            </td> <td>$ {
                formatNumber(y.balance, currentCurrency, false)
            }

            </td> `;
            tbody.appendChild(row);
        });
}

else {
    // Monthly view: show first 12, then every 12th, then last 12 months
    const displayMonths=new Set();

    if (totalMonths <=24) {
        // Show all months if 24 or fewer
        for (let i=1; i <=totalMonths; i++) displayMonths.add(i);
    }

    else {
        // Show first 12 months
        for (let i=1; i <=12; i++) displayMonths.add(i);
        // Show every 12th month in the middle
        for (let i=24; i <=totalMonths - 12; i +=12) displayMonths.add(i);
        // Show last 12 months
        for (let i=Math.max(13, totalMonths - 11); i <=totalMonths; i++) displayMonths.add(i);
    }

    schedule.forEach((entry)=> {
            if (displayMonths.has(entry.month)) {
                const row=document.createElement("tr");

                row.innerHTML=` <td>$ {
                    entry.month
                }

                </td> <td>$ {
                    formatNumber(entry.emi, currentCurrency, false)
                }

                </td> <td>$ {
                    formatNumber(entry.principal, currentCurrency, false)
                }

                </td> <td>$ {
                    formatNumber(entry.interest, currentCurrency, false)
                }

                </td> <td>$ {
                    formatNumber(entry.balance, currentCurrency, false)
                }

                </td> `;
                tbody.appendChild(row);
            }
        });
}
}

function recalcAll() {
    const currentMode=primaryModeSelect.value || "sip-basic";

    if (currentMode==="standard") {
        recalcStandard();
    }

    else if (currentMode==="sip-basic") {
        recalcSipBasic();
    }

    else if (currentMode==="sip-target") {
        recalcSipTarget();
    }

    else if (currentMode==="sip-duration") {
        recalcSipDuration();
    }

    else if (currentMode==="sip-roi") {
        recalcSipRoi();
    }

    else if (currentMode==="swp") {
        recalcSwp();
    }

    else if (currentMode==="amortization") {
        recalcAmortization();
    }

    else if (currentMode==="expenses") {
        recalcExpenses();
    }
}

function initDefaults() {
    const defaults= {
        housePrice: "5000000",
        years: "20",
        middleDown: "4000000",
        investorDown: "500000",
        middleRate: "8.5",
        investorRate: "6.5",
        houseGrowth: "8",
        equityReturn: "12",
        sipAmount: "25000",
        sipYears: "20",
        sipReturn: "12",
        sipStepUp: "10",
        targetCorpus: "10000000",
        targetYears: "20",
        targetReturn: "12",
        targetStepUp: "10",
        durSipAmount: "25000",
        durTargetCorpus: "10000000",
        durReturn: "12",
        durStepUp: "10",
        roiSipAmount: "25000",
        roiTargetCorpus: "10000000",
        roiYears: "20",
        roiStepUp: "10",
        swpCorpus: "5000000",
        swpDuration: "20",
        swpReturn: "7",
        swpWithdrawal: "40000",
        swpReqWithdrawal: "40000",
        swpReqDuration: "20",
        swpReqReturn: "7",
        stepUpPercentStandard: "10",
        amortPrincipal: "5000000",
        amortRate: "8.5",
        amortYears: "20",
    }

    ;

    Object.entries(defaults).forEach(([id, val])=> {
            const el=document.getElementById(id);

            if (el && !el.value) {
                el.value=val;
                formatInputWithCommas(el);
            }
        });

    [ "housePrice",
    "middleDown",
    "investorDown",
    "sipAmount",
    "targetCorpus",
    "durSipAmount",
    "durTargetCorpus",
    "roiSipAmount",
    "roiTargetCorpus",
    "swpCorpus",
    "swpWithdrawal",
    "swpReqWithdrawal",
    "amortPrincipal",
    ].forEach((id)=> {
            const input=document.getElementById(id);
            const wordsId=amountWordsMap[id];
            if ( !input || !wordsId) return;
            const raw=parseNumber(input.dataset.raw || input.value);

            if (raw > 0) {
                document.getElementById(wordsId).innerHTML=numberToWords(raw,
                    currentCurrency);
            }
        });
    document.getElementById("enableStepUpStandard").checked=true;
    document.getElementById("enableStepUpBasic").checked=true;
    document.getElementById("enableStepUpTarget").checked=true;
    document.getElementById("enableStepUpDur").checked=false;
    document.getElementById("enableStepUpRoi").checked=false;

    document.querySelectorAll(".currency-prefix").forEach((el)=> {
            el.textContent=currencyConfig[currentCurrency].symbol;
        });

    applyTheme(currentTheme);
    applyViewMode(simpleView ? "simple" : "advanced");
    setMode("sip-basic");
    recalcExpenses();
}

initDefaults();
})();
</script></div>
